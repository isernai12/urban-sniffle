{% extends 'base.html' %}

{# ‚úÖ Only detail page will show tracker + toc #}
{% set show_detail_tracker = true %}

{% block title %}{{ post['title'] }} ‚Ä¢ Writo{% endblock %}
{% block tracker_title %}{{ post['title'] }}{% endblock %}

{# ‚úÖ TOC modal content goes here (base.html renders modal only if show_detail_tracker=true) #}
{% block toc_modal_content %}
  {% if toc_items %}
    <div style="display:grid; gap:10px;">
      {% for item in toc_items %}
        <button
          type="button"
          data-toc-item="1"
          onclick="jumpToSection('{{ item.id }}', '{{ item.title | e }}')"
          style="
            width:100%;
            text-align:left;
            padding:12px 12px;
            border-radius:16px;
            border:1px solid rgba(0,0,0,0.10);
            background: rgba(255,255,255,0.35);
            color: var(--text);
            cursor:pointer;
            font-weight:700;
            font-size:13px;
          ">
          {{ item.title }}
        </button>
      {% endfor %}
    </div>
    <div class="writoHint">‡¶Ø‡ßá‡¶ï‡ßã‡¶®‡ßã ‡¶∏‡ßá‡¶ï‡¶∂‡¶®‡ßá ‡¶Ø‡ßá‡¶§‡ßá ‡¶ü‡ßç‡¶Ø‡¶æ‡¶™ ‡¶ï‡¶∞‡ßÅ‡¶®‡•§</div>
  {% else %}
    <div class="writoHint" style="margin:0">‡¶è‡¶á ‡¶™‡ßã‡¶∏‡ßç‡¶ü‡ßá ‡¶ï‡ßã‡¶®‡ßã TOC ‡¶®‡ßá‡¶á‡•§</div>
  {% endif %}
{% endblock %}

{% block content %}

  {# ‚úÖ Report modal (post/comment) #}
  <div id="reportModal" class="writoModal" aria-hidden="true">
    <div class="writoModalInner">
      <div class="writoModalHead">
        <div class="writoModalTitle"><span data-lucide="flag"></span> ‚ö†Ô∏è ‡¶∞‡¶ø‡¶™‡ßã‡¶∞‡ßç‡¶ü ‡¶ï‡¶∞‡ßÅ‡¶®</div>
        <button class="writoModalClose" type="button" onclick="closeReportModal()" aria-label="Close">
          <span data-lucide="x"></span>
        </button>
      </div>

      <form action="/report_content" method="post">
        <input type="hidden" name="post_id" id="report_post_id">
        <input type="hidden" name="comment_id" id="report_comment_id">

        <label style="display:block;margin-bottom:6px;font-weight:700;color:var(--text);">‡¶ï‡¶æ‡¶∞‡¶£ ‡¶®‡¶ø‡¶∞‡ßç‡¶¨‡¶æ‡¶ö‡¶® ‡¶ï‡¶∞‡ßÅ‡¶®:</label>
        <select name="reason"
                style="width:100%;padding:12px;border-radius:14px;border:1px solid rgba(0,0,0,0.10);
                       background: rgba(255,255,255,0.55); color:var(--text); font-family:inherit;">
          <option value="Spam">‡¶∏‡ßç‡¶™‡ßç‡¶Ø‡¶æ‡¶Æ / ‡¶Ö‡¶™‡ßç‡¶∞‡ßü‡ßã‡¶ú‡¶®‡ßÄ‡ßü</option>
          <option value="Abusive">‡¶ñ‡¶æ‡¶∞‡¶æ‡¶™ ‡¶≠‡¶æ‡¶∑‡¶æ / ‡¶ó‡¶æ‡¶≤‡¶ø‡¶ó‡¶æ‡¶≤‡¶æ‡¶ú</option>
          <option value="Misleading">‡¶≠‡ßÅ‡¶≤ ‡¶§‡¶•‡ßç‡¶Ø</option>
          <option value="Harassment">‡¶π‡ßü‡¶∞‡¶æ‡¶®‡¶ø</option>
        </select>

        <button type="submit"
                style="width:100%;margin-top:12px;padding:12px;border-radius:14px;border:none;
                       background:#ef4444;color:#fff;font-weight:800;cursor:pointer;">
          ‡¶ú‡¶Æ‡¶æ ‡¶¶‡¶ø‡¶®
        </button>
      </form>
    </div>
  </div>

  {# ‚úÖ Post card #}
  <div class="post">
    <div style="font-size:12px;color:var(--muted);font-weight:800;margin-bottom:8px;">
      {{ post['category'] }}
    </div>

    {# ‚úÖ first marker: post title #}
    <h1 id="postTop" class="toc-marker" data-title="{{ post['title'] }}"
        style="font-size:20px;line-height:1.25;">
      {{ post['title'] }}
    </h1>

    <p style="color: var(--muted); margin-top:8px; font-size:13px; line-height:1.6;">
      {{ post['intro'] }}
    </p>

    <div style="display:flex;align-items:center;gap:10px;margin-top:12px;">
      <div style="width:34px;height:34px;border-radius:50%;
                  background:rgba(148,163,184,.25);
                  overflow:hidden;display:flex;align-items:center;justify-content:center;
                  font-weight:800;color:var(--text);">
        {% if post['author_profile_pic'] %}
          <img src="{{ url_for('static', filename='profile_uploads/' + post['author_profile_pic']) }}"
               alt="profile" style="width:100%;height:100%;object-fit:cover;border-radius:50%;">
        {% else %}
          {{ post['author_display_name'][:1] }}
        {% endif %}
      </div>

      <div style="min-width:0;">
        <a href="{{ url_for('public_profile', user_id=post['user_id']) }}"
           style="text-decoration:none;color:var(--text);
                  font-weight:900;font-size:13px;display:inline-block;max-width:100%;
                  white-space:nowrap;overflow:hidden;text-overflow:ellipsis;">
          {{ post['author_display_name'] }}
        </a>
        <div style="font-size:12px;color:var(--muted);margin-top:2px;">
          ‚è±Ô∏è {{ post['read_time'] }} ‡¶™‡¶°‡¶º‡¶æ
        </div>
      </div>
    </div>

    <hr style="border:0;border-top:1px solid rgba(0,0,0,0.10);margin:14px 0;">

    {% if post['thumbnail'] %}
      <img src="{{ url_for('static', filename='uploads/' + post['thumbnail']) }}"
           style="margin-top:2px;border-radius:16px;width:100%;height:auto;">
      <hr style="border:0;border-top:1px solid rgba(0,0,0,0.10);margin:14px 0;">
    {% endif %}

    <div class="post-content" style="line-height:1.85; font-size:15px;">
      {% autoescape false %}
        {{ content | replace('\n', '<br>') }}
      {% endautoescape %}
    </div>

    <hr style="border:0;border-top:1px solid rgba(0,0,0,0.10);margin:16px 0;">

    {# Like + Report + Bookmark row #}
    <div style="display:flex;align-items:center;justify-content:space-between;gap:12px;">
      <div style="display:flex;align-items:center;gap:14px;">
        {% if current_user.is_authenticated %}
          <a href="{{ url_for('like_post', post_id=post['id']) }}" style="text-decoration:none;">
            {% if user_liked_post %}
              <span style="font-size:22px;">‚ù§Ô∏è</span>
            {% else %}
              <span style="font-size:22px;">ü§ç</span>
            {% endif %}
          </a>
        {% else %}
          <a href="/login" style="text-decoration:none;"><span style="font-size:22px;">ü§ç</span></a>
        {% endif %}

        <span style="font-weight:800;color:var(--muted);font-size:13px;">
          {{ post_like_count }} Likes
        </span>

        {% if current_user.is_authenticated %}
          <button onclick="openReportModal('post', '{{ post.id }}')"
                  style="background:none;border:none;font-size:12px;color:#ef4444;
                         cursor:pointer;text-decoration:underline;font-weight:800;">
            ‚ö†Ô∏è Report
          </button>
        {% endif %}
      </div>

      <div>
        {% if current_user.is_authenticated %}
          <a href="{{ url_for('toggle_bookmark', post_id=post['id']) }}"
             style="text-decoration:none;font-size:22px;" title="Bookmark">
            {% if is_bookmarked %} üîñ {% else %} üè∑Ô∏è {% endif %}
          </a>
        {% else %}
          <a href="/login" style="text-decoration:none;font-size:22px;">üè∑Ô∏è</a>
        {% endif %}
      </div>
    </div>
  </div>

  {# ‚úÖ Comments card #}
  <div class="post">
    <h3 style="margin-bottom:12px;font-size:16px;">‡¶Æ‡¶®‡ßç‡¶§‡¶¨‡ßç‡¶Ø ‡¶∏‡¶Æ‡ßÇ‡¶π</h3>

    {% if current_user.is_authenticated %}
      <form action="{{ url_for('add_comment', post_id=post['id']) }}" method="post" style="margin-bottom:16px;">
        <textarea name="content" rows="3" placeholder="‡¶∏‡ßÅ‡¶®‡ßç‡¶¶‡¶∞ ‡¶è‡¶ï‡¶ü‡¶ø ‡¶Æ‡¶®‡ßç‡¶§‡¶¨‡ßç‡¶Ø ‡¶ï‡¶∞‡ßÅ‡¶®..." required
                  style="width:100%;padding:12px;border-radius:14px;border:1px solid rgba(0,0,0,0.10);
                         background: rgba(255,255,255,0.55); color:var(--text);"></textarea>
        <button type="submit"
                style="margin-top:10px;padding:10px 14px;border-radius:14px;border:none;
                       background:rgba(37,99,235,0.95);color:#fff;font-weight:900;cursor:pointer;">
          ‡¶Æ‡¶®‡ßç‡¶§‡¶¨‡ßç‡¶Ø ‡¶ï‡¶∞‡ßÅ‡¶®
        </button>
      </form>
    {% else %}
      <div style="background: rgba(56,189,248,.12); border:1px solid rgba(56,189,248,.20);
                  padding:12px;border-radius:16px;margin-bottom:14px;font-size:13px;">
        ‡¶Æ‡¶®‡ßç‡¶§‡¶¨‡ßç‡¶Ø ‡¶ï‡¶∞‡¶§‡ßá <a href="/login" style="font-weight:900;color:var(--text);">‡¶≤‡¶ó ‡¶á‡¶®</a> ‡¶ï‡¶∞‡ßÅ‡¶®‡•§
      </div>
    {% endif %}

    {% for comment in comments %}
      <div style="border-bottom:1px solid rgba(0,0,0,0.10);padding-bottom:12px;margin-bottom:12px;">
        <div style="display:flex;justify-content:space-between;gap:10px;">
          <strong style="color:var(--text);font-size:13px;">{{ comment['username'] }}</strong>
          <small style="color:var(--muted);font-size:12px;">{{ comment['created_at'] }}</small>
        </div>

        <p style="margin:8px 0 10px; font-size:13px; line-height:1.7;">{{ comment['content'] }}</p>

        <div style="display:flex;align-items:center;gap:14px;">
          <div style="display:flex;align-items:center;gap:6px;">
            {% if current_user.is_authenticated %}
              <a href="{{ url_for('like_comment', comment_id=comment['id'], post_id=post['id']) }}"
                 style="text-decoration:none;">
                {% if comment['id'] in liked_comments %}
                  <span style="font-size:16px;">‚ù§Ô∏è</span>
                {% else %}
                  <span style="font-size:16px;">ü§ç</span>
                {% endif %}
              </a>
            {% else %}
              <span style="font-size:16px;">ü§ç</span>
            {% endif %}
            <small style="color:var(--muted);font-weight:800;">{{ comment['like_count'] }}</small>
          </div>

          {% if current_user.is_authenticated %}
            <button onclick="openReportModal('comment', '{{ comment.id }}', '{{ post.id }}')"
                    style="background:none;border:none;font-size:12px;color:#ef4444;cursor:pointer;font-weight:800;">
              ‚ö†Ô∏è Report
            </button>
          {% endif %}
        </div>
      </div>
    {% else %}
      <p style="color:var(--muted); text-align:center; font-size:13px; padding:8px 0;">
        ‡¶ï‡ßã‡¶®‡ßã ‡¶Æ‡¶®‡ßç‡¶§‡¶¨‡ßç‡¶Ø ‡¶®‡ßá‡¶á‡•§ ‡¶Ü‡¶™‡¶®‡¶ø‡¶á ‡¶™‡ßç‡¶∞‡¶•‡¶Æ ‡¶Æ‡¶®‡ßç‡¶§‡¶¨‡ßç‡¶Ø ‡¶ï‡¶∞‡ßÅ‡¶®!
      </p>
    {% endfor %}
  </div>

  {# ‚úÖ Related posts #}
  {% if related_posts %}
    <div class="post">
      <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:10px;">
        <strong style="font-size:14px;">üîó ‡¶∏‡¶Æ‡ßç‡¶™‡¶∞‡ßç‡¶ï‡¶ø‡¶§ ‡¶™‡ßã‡¶∏‡ßç‡¶ü</strong>
      </div>

      <div style="display:grid; gap:12px;">
        {% for rel_post in related_posts %}
          <div class="post" style="margin:0; cursor:pointer;"
               onclick="window.location.href='{{ url_for('post_detail', post_id=rel_post['id'], slug=rel_post['slug']) }}'">
            <div style="font-size:14px;font-weight:900;margin-bottom:6px;">
              {{ rel_post['title'] }}
            </div>

            <div style="display:flex;align-items:center;gap:10px;">
              <div style="width:28px;height:28px;border-radius:50%;
                          background:rgba(148,163,184,.25);
                          overflow:hidden;display:flex;align-items:center;justify-content:center;
                          font-weight:900;color:var(--text);font-size:12px;">
                {% if rel_post['author_profile_pic'] %}
                  <img src="{{ url_for('static', filename='profile_uploads/' + rel_post['author_profile_pic']) }}"
                       alt="profile" style="width:100%;height:100%;object-fit:cover;border-radius:50%;">
                {% else %}
                  {{ rel_post['author_display_name'][:1] }}
                {% endif %}
              </div>

              <a href="{{ url_for('public_profile', user_id=rel_post['user_id']) }}"
                 style="text-decoration:none;color:var(--muted);font-weight:900;font-size:12px;">
                {{ rel_post['author_display_name'] }}
              </a>
            </div>
          </div>
        {% endfor %}
      </div>
    </div>
  {% endif %}

{% endblock %}

{% block body_scripts %}
<script>
  // ‚úÖ For tracker title (base.html uses id="currentSection")
  const currentTitleEl = document.getElementById("currentSection");

  // ‚úÖ Close report modal (custom modal)
  function closeReportModal(){
    const rm = document.getElementById("reportModal");
    if (rm) rm.classList.remove("open");
    document.body.classList.remove("hasOverlay");
  }

  // ‚úÖ Open report modal
  function openReportModal(type, id, postId=null) {
    const rm = document.getElementById("reportModal");
    if (!rm) return;

    rm.classList.add("open");
    document.body.classList.add("hasOverlay");

    const postInput = document.getElementById("report_post_id");
    const comInput  = document.getElementById("report_comment_id");

    if (type === "post") {
      if (postInput) postInput.value = id;
      if (comInput)  comInput.value  = "";
    } else {
      if (comInput)  comInput.value  = id;
      if (postInput) postInput.value = postId || "";
    }
  }

  // ‚úÖ Jump to section by id (TOC item click)
  function jumpToSection(id, title){
    // close TOC modal if open
    const tocModal = document.getElementById("writoModalToc");
    const tocBtn   = document.getElementById("tocBtn");
    if (tocModal) tocModal.classList.remove("open");
    if (tocBtn) tocBtn.classList.remove("open");
    document.body.classList.remove("hasOverlay");

    if (currentTitleEl) currentTitleEl.textContent = title;

    const section = document.getElementById(id);
    if (section){
      const offset = document.body.classList.contains("compactHeader") ? 80 : 120;
      const top = section.getBoundingClientRect().top + window.pageYOffset - offset;
      window.scrollTo({ top, behavior:"smooth" });
    }
  }

  // ‚úÖ Scroll-based tracker title update (.toc-marker)
  function updateActiveTitle(){
    const markers = document.querySelectorAll(".toc-marker");
    if (!markers.length) return;

    let active = markers[0].getAttribute("data-title") || "{{ post['title'] }}";
    markers.forEach(m => {
      const r = m.getBoundingClientRect();
      if (r.top < 160) active = m.getAttribute("data-title") || active;
    });
    if (currentTitleEl && active) currentTitleEl.textContent = active;
  }

  updateActiveTitle();
  window.addEventListener("scroll", () => requestAnimationFrame(updateActiveTitle), { passive:true });

  // ‚úÖ Expose functions to inline onclick
  window.jumpToSection = jumpToSection;
  window.openReportModal = openReportModal;
  window.closeReportModal = closeReportModal;
</script>
{% endblock %}
