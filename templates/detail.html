{% extends 'base.html' %}

{% block title %}{{ post['title'] }} ‚Ä¢ Writo{% endblock %}

<!-- ‚úÖ detail page marker -->
{% block body_class %}hasDetailTracker{% endblock %}

<!-- ‚úÖ tracker title (only detail will show it) -->
{% block tracker_title %}{{ post['title'] }}{% endblock %}

<!-- ‚úÖ TOC modal content -->
{% block toc_modal_content %}
  {% if toc_items %}
    <div style="display:grid; gap:10px;">
      {% for item in toc_items %}
        <button
          type="button"
          data-toc-item="1"
          onclick="jumpToSection('{{ item.id }}', '{{ item.title | e }}')"
          style="
            width:100%;
            text-align:left;
            padding:12px 12px;
            border-radius:16px;
            border:1px solid rgba(0,0,0,0.10);
            background: rgba(255,255,255,0.35);
            color: var(--text);
            cursor:pointer;
            font-weight:700;
            font-size:13px;
          ">
          {{ item.title }}
        </button>
      {% endfor %}
    </div>
    <div class="writoHint">‡¶Ø‡ßá‡¶ï‡ßã‡¶®‡ßã ‡¶∏‡ßá‡¶ï‡¶∂‡¶®‡ßá ‡¶Ø‡ßá‡¶§‡ßá ‡¶ü‡ßç‡¶Ø‡¶æ‡¶™ ‡¶ï‡¶∞‡ßÅ‡¶®‡•§</div>
  {% else %}
    <div class="writoHint" style="margin:0">‡¶è‡¶á ‡¶™‡ßã‡¶∏‡ßç‡¶ü‡ßá ‡¶ï‡ßã‡¶®‡ßã TOC ‡¶®‡ßá‡¶á‡•§</div>
  {% endif %}
{% endblock %}

{% block content %}

  <!-- ‚úÖ Report modal -->
  <section class="writoModal" id="reportModal" aria-hidden="true" style="top:72px;">
    <div class="writoModalInner">
      <div class="writoModalHead">
        <div class="writoModalTitle"><span data-lucide="flag"></span> ‡¶∞‡¶ø‡¶™‡ßã‡¶∞‡ßç‡¶ü ‡¶ï‡¶∞‡ßÅ‡¶®</div>
        <button class="writoModalClose" type="button" onclick="closeReportModal()" aria-label="Close">
          <span data-lucide="x"></span>
        </button>
      </div>

      <form action="/report_content" method="post">
        <input type="hidden" name="post_id" id="report_post_id">
        <input type="hidden" name="comment_id" id="report_comment_id">

        <label style="display:block;margin-bottom:6px;font-weight:700;font-size:13px;color:var(--muted);">
          ‡¶ï‡¶æ‡¶∞‡¶£ ‡¶®‡¶ø‡¶∞‡ßç‡¶¨‡¶æ‡¶ö‡¶® ‡¶ï‡¶∞‡ßÅ‡¶®
        </label>
        <select name="reason"
                style="width:100%;height:42px;border-radius:14px;border:1px solid rgba(0,0,0,0.10);background:rgba(255,255,255,0.55);padding:0 12px;color:var(--text);">
          <option value="Spam">‡¶∏‡ßç‡¶™‡ßç‡¶Ø‡¶æ‡¶Æ / ‡¶Ö‡¶™‡ßç‡¶∞‡ßü‡ßã‡¶ú‡¶®‡ßÄ‡ßü</option>
          <option value="Abusive">‡¶ñ‡¶æ‡¶∞‡¶æ‡¶™ ‡¶≠‡¶æ‡¶∑‡¶æ / ‡¶ó‡¶æ‡¶≤‡¶ø‡¶ó‡¶æ‡¶≤‡¶æ‡¶ú</option>
          <option value="Misleading">‡¶≠‡ßÅ‡¶≤ ‡¶§‡¶•‡ßç‡¶Ø</option>
          <option value="Harassment">‡¶π‡ßü‡¶∞‡¶æ‡¶®‡¶ø</option>
        </select>

        <button type="submit"
                style="margin-top:12px;width:100%;height:42px;border:none;border-radius:14px;background:#ef4444;color:#fff;font-weight:800;cursor:pointer;">
          ‡¶ú‡¶Æ‡¶æ ‡¶¶‡¶ø‡¶®
        </button>
      </form>
    </div>
  </section>

  <div class="post">
    <div style="font-size:12px;color:var(--muted);font-weight:700;margin-bottom:8px;">
      {{ post['category'] }}
    </div>

    <!-- ‚úÖ first marker -->
    <h1 id="postTop" class="toc-marker" data-title="{{ post['title'] }}" style="font-size:20px;line-height:1.25;">
      {{ post['title'] }}
    </h1>

    <p style="color: var(--muted); margin-top:8px; font-size:13px; line-height:1.6;">
      {{ post['intro'] }}
    </p>

    <div style="display:flex;align-items:center;gap:10px;margin-top:12px;">
      <div style="width:34px;height:34px;border-radius:50%;background:rgba(148,163,184,.25);overflow:hidden;display:flex;align-items:center;justify-content:center;font-weight:800;color:var(--text);">
        {% if post['author_profile_pic'] %}
          <img src="{{ url_for('static', filename='profile_uploads/' + post['author_profile_pic']) }}"
               alt="profile" style="width:100%;height:100%;object-fit:cover;border-radius:50%;">
        {% else %}
          {{ post['author_display_name'][:1] }}
        {% endif %}
      </div>

      <div style="min-width:0;">
        <a href="{{ url_for('public_profile', user_id=post['user_id']) }}"
           style="text-decoration:none;color:var(--text);font-weight:800;font-size:13px;display:inline-block;max-width:100%;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;">
          {{ post['author_display_name'] }}
        </a>
        <div style="font-size:12px;color:var(--muted);margin-top:2px;">‚è±Ô∏è {{ post['read_time'] }} ‡¶™‡¶°‡¶º‡¶æ</div>
      </div>
    </div>

    {% if post['thumbnail'] %}
      <img src="{{ url_for('static', filename='uploads/' + post['thumbnail']) }}"
           style="margin-top:14px;border-radius:16px;width:100%;height:auto;">
    {% endif %}

    <div class="post-content" style="margin-top:14px; line-height:1.85; font-size:15px;">
      {% autoescape false %}
        {{ content | replace('\n', '<br>') }}
      {% endautoescape %}
    </div>

    <hr style="margin-top:18px;border:none;border-top:1px solid rgba(148,163,184,.25);">

    <div style="display:flex;align-items:center;justify-content:space-between;margin-top:12px;">
      <div style="display:flex;align-items:center;gap:14px;">
        {% if current_user.is_authenticated %}
          <a href="{{ url_for('like_post', post_id=post['id']) }}" style="text-decoration:none;">
            {% if user_liked_post %}<span style="font-size:22px;">‚ù§Ô∏è</span>{% else %}<span style="font-size:22px;">ü§ç</span>{% endif %}
          </a>
        {% else %}
          <a href="/login" style="text-decoration:none;"><span style="font-size:22px;">ü§ç</span></a>
        {% endif %}
        <span style="font-weight:800;color:var(--muted);font-size:13px;">{{ post_like_count }} Likes</span>

        {% if current_user.is_authenticated %}
          <button onclick="openReportModal('post','{{ post.id }}')"
                  style="background:none;border:none;font-size:12px;color:#ef4444;cursor:pointer;text-decoration:underline;font-weight:800;">
            ‚ö†Ô∏è Report
          </button>
        {% endif %}
      </div>

      <div>
        {% if current_user.is_authenticated %}
          <a href="{{ url_for('toggle_bookmark', post_id=post['id']) }}" style="text-decoration:none;font-size:22px;" title="Bookmark">
            {% if is_bookmarked %} üîñ {% else %} üè∑Ô∏è {% endif %}
          </a>
        {% else %}
          <a href="/login" style="text-decoration:none;font-size:22px;">üè∑Ô∏è</a>
        {% endif %}
      </div>
    </div>
  </div>

  <div class="post">
    <h3 style="margin-bottom:12px;">‡¶Æ‡¶®‡ßç‡¶§‡¶¨‡ßç‡¶Ø ‡¶∏‡¶Æ‡ßÇ‡¶π</h3>

    {% if current_user.is_authenticated %}
      <form action="{{ url_for('add_comment', post_id=post['id']) }}" method="post" style="margin-bottom:18px;">
        <textarea name="content" rows="3" placeholder="‡¶∏‡ßÅ‡¶®‡ßç‡¶¶‡¶∞ ‡¶è‡¶ï‡¶ü‡¶ø ‡¶Æ‡¶®‡ßç‡¶§‡¶¨‡ßç‡¶Ø ‡¶ï‡¶∞‡ßÅ‡¶®..." required
                  style="width:100%;padding:12px;border-radius:14px;border:1px solid rgba(0,0,0,0.10);background:rgba(255,255,255,0.55);color:var(--text);"></textarea>
        <button type="submit"
                style="margin-top:10px;height:40px;padding:0 14px;border:none;border-radius:14px;background:var(--text);color:var(--bg);font-weight:800;cursor:pointer;">
          ‡¶Æ‡¶®‡ßç‡¶§‡¶¨‡ßç‡¶Ø ‡¶ï‡¶∞‡ßÅ‡¶®
        </button>
      </form>
    {% else %}
      <div class="writoHint" style="margin:0;background:rgba(59,130,246,.10);border:1px solid rgba(59,130,246,.18);border-radius:16px;padding:12px;">
        ‡¶Æ‡¶®‡ßç‡¶§‡¶¨‡ßç‡¶Ø ‡¶ï‡¶∞‡¶§‡ßá <a href="/login" style="color:var(--text);font-weight:800;">‡¶≤‡¶ó ‡¶á‡¶®</a> ‡¶ï‡¶∞‡ßÅ‡¶®‡•§
      </div>
    {% endif %}

    {% for comment in comments %}
      <div style="border-bottom:1px solid rgba(148,163,184,.20); padding-bottom:12px; margin-bottom:12px;">
        <div style="display:flex;justify-content:space-between;gap:10px;">
          <strong style="color:var(--text);font-size:13px;">{{ comment['username'] }}</strong>
          <small style="color:var(--muted);font-size:12px;">{{ comment['created_at'] }}</small>
        </div>
        <p style="margin:6px 0;color:var(--text);font-size:13px;line-height:1.6;">{{ comment['content'] }}</p>

        <div style="display:flex;align-items:center;gap:14px;">
          <div style="display:flex;align-items:center;gap:6px;">
            {% if current_user.is_authenticated %}
              <a href="{{ url_for('like_comment', comment_id=comment['id'], post_id=post['id']) }}" style="text-decoration:none;">
                {% if comment['id'] in liked_comments %}<span style="font-size:16px;">‚ù§Ô∏è</span>{% else %}<span style="font-size:16px;">ü§ç</span>{% endif %}
              </a>
            {% else %}
              <span style="font-size:16px;">ü§ç</span>
            {% endif %}
            <small style="color:var(--muted);font-weight:800;">{{ comment['like_count'] }}</small>
          </div>

          {% if current_user.is_authenticated %}
            <button onclick="openReportModal('comment','{{ comment.id }}','{{ post.id }}')"
                    style="background:none;border:none;font-size:12px;color:#ef4444;cursor:pointer;font-weight:800;">
              ‚ö†Ô∏è Report
            </button>
          {% endif %}
        </div>
      </div>
    {% else %}
      <p style="color:var(--muted);text-align:center;">‡¶ï‡ßã‡¶®‡ßã ‡¶Æ‡¶®‡ßç‡¶§‡¶¨‡ßç‡¶Ø ‡¶®‡ßá‡¶á‡•§ ‡¶Ü‡¶™‡¶®‡¶ø‡¶á ‡¶™‡ßç‡¶∞‡¶•‡¶Æ ‡¶Æ‡¶®‡ßç‡¶§‡¶¨‡ßç‡¶Ø ‡¶ï‡¶∞‡ßÅ‡¶®!</p>
    {% endfor %}
  </div>

{% endblock %}

{% block body_scripts %}
<script>
  const currentTitleEl = document.getElementById("currentSection");
  const tocModal = document.getElementById("writoModalToc");

  function jumpToSection(id, title){
    // close any open modal
    document.querySelectorAll("[data-writo-close]").forEach(btn => btn.click());

    if (currentTitleEl) currentTitleEl.textContent = title;

    const section = document.getElementById(id);
    if (section){
      const offset = document.body.classList.contains("compactHeader") ? 80 : 110;
      const top = section.getBoundingClientRect().top + window.pageYOffset - offset;
      window.scrollTo({ top, behavior:"smooth" });
    }
  }

  // scroll-based section title update
  function updateActiveTitle(){
    const markers = document.querySelectorAll(".toc-marker");
    if (!markers.length) return;

    let active = markers[0].getAttribute("data-title") || "";
    markers.forEach(m => {
      const r = m.getBoundingClientRect();
      if (r.top < 160) active = m.getAttribute("data-title") || active;
    });
    if (currentTitleEl && active) currentTitleEl.textContent = active;
  }
  updateActiveTitle();
  window.addEventListener("scroll", () => requestAnimationFrame(updateActiveTitle), { passive:true });

  // Report modal open/close
  const reportModal = document.getElementById("reportModal");
  function openReportModal(type, id, postId=null){
    reportModal.classList.add("open");
    document.body.classList.add("hasOverlay");

    document.getElementById("report_post_id").value = (type === "post") ? id : (postId || "");
    document.getElementById("report_comment_id").value = (type === "comment") ? id : "";
  }
  function closeReportModal(){
    reportModal.classList.remove("open");
    document.body.classList.remove("hasOverlay");
  }

  window.jumpToSection = jumpToSection;
  window.openReportModal = openReportModal;
  window.closeReportModal = closeReportModal;
</script>
{% endblock %}
