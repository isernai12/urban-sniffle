{% extends 'base.html' %}

{% block header_extension %}
    <div class="subRow">
        <div class="subTitle" id="currentTitle">‡¶™‡¶æ‡¶á‡¶•‡¶® ‡¶¨‡ßç‡¶≤‡¶ó</div>
        {% if toc_items %}
            <button class="moreBtn" id="moreBtn" type="button">More</button>
        {% else %}
            <div style="width: 78px;"></div>
        {% endif %}
    </div>

    <div class="moreList" id="moreList">
        {% for item in toc_items %}
            <div class="moreItem" onclick="jumpToSection('{{ item.id }}', '{{ item.title }}')">
                {{ item.title }}
            </div>
        {% endfor %}
    </div>

    <style> .spacer { height: 160px !important; } </style>
{% endblock %}

{% block content %}
    <div id="reportModal" class="modal-overlay">
        <div class="modal-box">
            <div class="modal-header">
                <h3>‚ö†Ô∏è ‡¶∞‡¶ø‡¶™‡ßã‡¶∞‡ßç‡¶ü ‡¶ï‡¶∞‡ßÅ‡¶®</h3>
                <button class="close-modal" onclick="document.getElementById('reportModal').style.display='none'">&times;</button>
            </div>
            <form action="/report_content" method="post">
                <input type="hidden" name="post_id" id="report_post_id">
                <input type="hidden" name="comment_id" id="report_comment_id">

                <label style="display: block; margin-bottom: 5px; font-weight: bold;">‡¶ï‡¶æ‡¶∞‡¶£ ‡¶®‡¶ø‡¶∞‡ßç‡¶¨‡¶æ‡¶ö‡¶® ‡¶ï‡¶∞‡ßÅ‡¶®:</label>
                <select name="reason" style="width: 100%; padding: 10px; margin-bottom: 15px; border-radius: 8px;">
                    <option value="Spam">‡¶∏‡ßç‡¶™‡ßç‡¶Ø‡¶æ‡¶Æ / ‡¶Ö‡¶™‡ßç‡¶∞‡ßü‡ßã‡¶ú‡¶®‡ßÄ‡ßü</option>
                    <option value="Abusive">‡¶ñ‡¶æ‡¶∞‡¶æ‡¶™ ‡¶≠‡¶æ‡¶∑‡¶æ / ‡¶ó‡¶æ‡¶≤‡¶ø‡¶ó‡¶æ‡¶≤‡¶æ‡¶ú</option>
                    <option value="Misleading">‡¶≠‡ßÅ‡¶≤ ‡¶§‡¶•‡ßç‡¶Ø</option>
                    <option value="Harassment">‡¶π‡ßü‡¶∞‡¶æ‡¶®‡¶ø</option>
                </select>

                <button type="submit" class="sub-btn" style="background: #ef4444;">‡¶ú‡¶Æ‡¶æ ‡¶¶‡¶ø‡¶®</button>
            </form>
        </div>
    </div>

    <div class="post">
        <span class="tag">{{ post['category'] }}</span>
        <h1 style="margin-top: 10px;">{{ post['title'] }}</h1>
        <p style="color: #64748b;">{{ post['intro'] }}</p>
        <div class="author-row">
            <div class="author-avatar">
                {% if post['author_profile_pic'] %}
                    <img src="{{ url_for('static', filename='profile_uploads/' + post['author_profile_pic']) }}" alt="profile">
                {% else %}
                    {{ post['author_display_name'][:1] }}
                {% endif %}
            </div>
            <div>
                <a class="author-name" href="{{ url_for('public_profile', user_id=post['user_id']) }}">{{ post['author_display_name'] }}</a>
                <div class="author-meta">‚è±Ô∏è {{ post['read_time'] }} ‡¶™‡¶°‡¶º‡¶æ</div>
            </div>
        </div>
        <hr style="border: 0; border-top: 1px solid #e2e8f0; margin: 15px 0;">

        {% if post['thumbnail'] %}
            <img src="{{ url_for('static', filename='uploads/' + post['thumbnail']) }}" style="margin-bottom: 20px;">
        {% endif %}

        <div class="post-content" style="line-height: 1.8; font-size: 1.1em;">
            {% autoescape false %}
                {{ content | replace('\n', '<br>') }}
            {% endautoescape %}
        </div>

        <hr style="margin-top: 30px; border-color: #eee;">

        <div style="display: flex; align-items: center; justify-content: space-between; margin-top: 15px;">

            <div style="display: flex; align-items: center; gap: 15px;">
                {% if current_user.is_authenticated %}
                    <a href="{{ url_for('like_post', post_id=post['id']) }}" style="text-decoration: none;">
                        {% if user_liked_post %} <span style="font-size: 24px;">‚ù§Ô∏è</span> {% else %} <span style="font-size: 24px;">ü§ç</span> {% endif %}
                    </a>
                {% else %}
                    <a href="/login" style="text-decoration: none;"><span style="font-size: 24px;">ü§ç</span></a>
                {% endif %}
                <span style="font-weight: bold; color: #555;">{{ post_like_count }} Likes</span>

                {% if current_user.is_authenticated %}
                    <button onclick="openReportModal('post', '{{ post.id }}')" style="background: none; border: none; font-size: 0.9em; color: #ef4444; cursor: pointer; text-decoration: underline;">
                        ‚ö†Ô∏è Report
                    </button>
                {% endif %}
            </div>

            <div>
                {% if current_user.is_authenticated %}
                    <a href="{{ url_for('toggle_bookmark', post_id=post['id']) }}" style="text-decoration: none; font-size: 24px;" title="Bookmark">
                        {% if is_bookmarked %} üîñ {% else %} üè∑Ô∏è {% endif %}
                    </a>
                {% else %}
                    <a href="/login" style="text-decoration: none; font-size: 24px;">üè∑Ô∏è</a>
                {% endif %}
            </div>
        </div>
    </div>

    <div class="post">
        <h3 style="margin-bottom: 15px;">‡¶Æ‡¶®‡ßç‡¶§‡¶¨‡ßç‡¶Ø ‡¶∏‡¶Æ‡ßÇ‡¶π</h3>

        {% if current_user.is_authenticated %}
            <form action="{{ url_for('add_comment', post_id=post['id']) }}" method="post" style="margin-bottom: 30px;">
                <textarea name="content" rows="3" placeholder="‡¶∏‡ßÅ‡¶®‡ßç‡¶¶‡¶∞ ‡¶è‡¶ï‡¶ü‡¶ø ‡¶Æ‡¶®‡ßç‡¶§‡¶¨‡ßç‡¶Ø ‡¶ï‡¶∞‡ßÅ‡¶®..." required></textarea>
                <button type="submit" class="sub-btn" style="width: auto; padding: 8px 20px;">‡¶Æ‡¶®‡ßç‡¶§‡¶¨‡ßç‡¶Ø ‡¶ï‡¶∞‡ßÅ‡¶®</button>
            </form>
        {% else %}
            <p style="background: #f0f9ff; padding: 15px; border-radius: 8px; margin-bottom: 20px;">
                ‡¶Æ‡¶®‡ßç‡¶§‡¶¨‡ßç‡¶Ø ‡¶ï‡¶∞‡¶§‡ßá <a href="/login">‡¶≤‡¶ó ‡¶á‡¶®</a> ‡¶ï‡¶∞‡ßÅ‡¶®‡•§
            </p>
        {% endif %}

        {% for comment in comments %}
            <div style="border-bottom: 1px solid #eee; padding-bottom: 15px; margin-bottom: 15px;">
                <div style="display: flex; justify-content: space-between;">
                    <strong style="color: #0f172a;">{{ comment['username'] }}</strong>
                    <small style="color: #999;">{{ comment['created_at'] }}</small>
                </div>
                <p style="margin: 5px 0;">{{ comment['content'] }}</p>

                <div style="display: flex; align-items: center; gap: 15px;">
                    <div style="display: flex; align-items: center; gap: 5px;">
                        {% if current_user.is_authenticated %}
                            <a href="{{ url_for('like_comment', comment_id=comment['id'], post_id=post['id']) }}" style="text-decoration: none;">
                                {% if comment['id'] in liked_comments %} <span style="font-size: 16px;">‚ù§Ô∏è</span> {% else %} <span style="font-size: 16px;">ü§ç</span> {% endif %}
                            </a>
                        {% else %} <span>ü§ç</span> {% endif %}
                        <small style="color: #666;">{{ comment['like_count'] }}</small>
                    </div>

                    {% if current_user.is_authenticated %}
                        <button onclick="openReportModal('comment', '{{ comment.id }}', '{{ post.id }}')" style="background: none; border: none; font-size: 0.8em; color: #ef4444; cursor: pointer;">
                            ‚ö†Ô∏è Report
                        </button>
                    {% endif %}
                </div>
            </div>
        {% else %}
            <p style="color: #777; text-align: center;">‡¶ï‡ßã‡¶®‡ßã ‡¶Æ‡¶®‡ßç‡¶§‡¶¨‡ßç‡¶Ø ‡¶®‡ßá‡¶á‡•§ ‡¶Ü‡¶™‡¶®‡¶ø‡¶á ‡¶™‡ßç‡¶∞‡¶•‡¶Æ ‡¶Æ‡¶®‡ßç‡¶§‡¶¨‡ßç‡¶Ø ‡¶ï‡¶∞‡ßÅ‡¶®!</p>
        {% endfor %}
    </div>

    {% if related_posts %}
         <div class="section-header">
            <span class="section-title">üîó ‡¶∏‡¶Æ‡ßç‡¶™‡¶∞‡ßç‡¶ï‡¶ø‡¶§ ‡¶™‡ßã‡¶∏‡ßç‡¶ü</span>
        </div>
        <div style="display: grid; gap: 15px;">
            {% for rel_post in related_posts %}
                <div class="post" style="margin-bottom: 0; cursor: pointer;" onclick="window.location.href='{{ url_for('post_detail', post_id=rel_post['id']) }}'">
                    <h3 style="font-size: 1rem; margin: 0;">{{ rel_post['title'] }}</h3>
                    <div class="author-row" style="margin-top: 6px;">
                        <div class="author-avatar" style="width: 28px; height: 28px; font-size: 0.75rem;">
                            {% if rel_post['author_profile_pic'] %}
                                <img src="{{ url_for('static', filename='profile_uploads/' + rel_post['author_profile_pic']) }}" alt="profile">
                            {% else %}
                                {{ rel_post['author_display_name'][:1] }}
                            {% endif %}
                        </div>
                        <a class="author-name" style="font-size: 0.85rem;" href="{{ url_for('public_profile', user_id=rel_post['user_id']) }}">{{ rel_post['author_display_name'] }}</a>
                    </div>
                </div>
            {% endfor %}
        </div>
    {% endif %}

    <script>
        // TOC ‡¶è‡¶¨‡¶Ç ‡¶∏‡ßç‡¶ï‡ßç‡¶∞‡¶≤ ‡¶≤‡¶ú‡¶ø‡¶ï
        const currentTitle = document.getElementById("currentTitle");
        const moreListContainer = document.getElementById("moreList");
        const moreBtnElement = document.getElementById("moreBtn");

        if(currentTitle) currentTitle.textContent = "{{ post['title'] }}";

        if (moreBtnElement && moreListContainer) {
            moreBtnElement.addEventListener("click", () => {
                moreListContainer.classList.toggle("open");
                moreBtnElement.textContent = moreListContainer.classList.contains("open") ? "Close" : "More";
            });
        }

        function jumpToSection(id, title) {
            if(moreListContainer) moreListContainer.classList.remove("open");
            if(moreBtnElement) moreBtnElement.textContent = "More";
            currentTitle.textContent = title;
            const section = document.getElementById(id);
            if (section) {
                const offset = 170; 
                const top = section.getBoundingClientRect().top + window.pageYOffset - offset;
                window.scrollTo({ top: top, behavior: "smooth" });
            }
        }

        const markers = document.querySelectorAll('.toc-marker');
        window.addEventListener('scroll', () => {
            if (markers.length === 0) return;
            let activeTitle = "{{ post['title'] }}";
            markers.forEach(marker => {
                const rect = marker.getBoundingClientRect();
                if (rect.top < 220) { 
                    activeTitle = marker.getAttribute('data-title');
                }
            });
            if(currentTitle) currentTitle.textContent = activeTitle;
        });

        // ‡¶∞‡¶ø‡¶™‡ßã‡¶∞‡ßç‡¶ü ‡¶Æ‡¶°‡¶æ‡¶≤ ‡¶ì‡¶™‡ßá‡¶® ‡¶ï‡¶∞‡¶æ‡¶∞ ‡¶≤‡¶ú‡¶ø‡¶ï
        function openReportModal(type, id, postId=null) {
            document.getElementById('reportModal').style.display = 'block';
            if (type === 'post') {
                document.getElementById('report_post_id').value = id;
                document.getElementById('report_comment_id').value = '';
            } else {
                document.getElementById('report_comment_id').value = id;
                document.getElementById('report_post_id').value = postId; 
            }
        }
    </script>
{% endblock %}
