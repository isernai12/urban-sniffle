{% extends 'base.html' %}

{% block header_extension %}
    <div class="subRow">
        <div class="subTitle" id="currentTitle">পোস্ট প্রিভিউ</div>
        {% if toc_items %}
            <button class="moreBtn" id="moreBtn" type="button">More</button>
        {% else %}
            <div style="width: 78px;"></div>
        {% endif %}
    </div>

    <div class="moreList" id="moreList">
        {% for item in toc_items %}
            <div class="moreItem" onclick="jumpToSection('{{ item.id }}', '{{ item.title }}')">
                {{ item.title }}
            </div>
        {% endfor %}
    </div>

    <style> .spacer { height: 160px !important; } </style>
{% endblock %}

{% block content %}
    <div class="post">
        <span class="tag">{{ post['category'] }}</span>
        <h1 style="margin-top: 10px;">{{ post['title'] }}</h1>
        <p style="color: #64748b;">{{ post['intro'] }}</p>
        <div class="author-row">
            <div class="author-avatar">
                {% if post['author_profile_pic'] %}
                    <img src="{{ url_for('static', filename='profile_uploads/' + post['author_profile_pic']) }}" alt="profile">
                {% else %}
                    {{ post['author_display_name'][:1] }}
                {% endif %}
            </div>
            <div>
                <div class="author-name">{{ post['author_display_name'] }}</div>
                <div class="author-meta">⏱️ {{ post['read_time'] }} পড়া</div>
            </div>
        </div>
        <hr style="border: 0; border-top: 1px solid #e2e8f0; margin: 15px 0;">

        {% if post['thumbnail'] %}
            <img src="{{ url_for('static', filename='uploads/' + post['thumbnail']) }}" style="margin-bottom: 20px;">
        {% endif %}

        <div class="post-content" style="line-height: 1.8; font-size: 1.1em;">
            {% autoescape false %}
                {{ content | replace('\n', '<br>') }}
            {% endautoescape %}
        </div>
    </div>

    <script>
        const currentTitle = document.getElementById("currentTitle");
        const moreListContainer = document.getElementById("moreList");
        const moreBtnElement = document.getElementById("moreBtn");

        if(currentTitle) currentTitle.textContent = "{{ post['title'] }}";

        if (moreBtnElement && moreListContainer) {
            moreBtnElement.addEventListener("click", () => {
                moreListContainer.classList.toggle("open");
                moreBtnElement.textContent = moreListContainer.classList.contains("open") ? "Close" : "More";
            });
        }

        function jumpToSection(id, title) {
            if(moreListContainer) moreListContainer.classList.remove("open");
            if(moreBtnElement) moreBtnElement.textContent = "More";
            currentTitle.textContent = title;
            const section = document.getElementById(id);
            if (section) {
                const offset = 170; 
                const top = section.getBoundingClientRect().top + window.pageYOffset - offset;
                window.scrollTo({ top: top, behavior: "smooth" });
            }
        }
    </script>
{% endblock %}
