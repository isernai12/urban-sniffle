<!DOCTYPE html>
<html lang="bn">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Writo</title>

  <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;500;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
  <script src="https://unpkg.com/lucide@latest"></script>

  <style>
    *{margin:0;padding:0;box-sizing:border-box}

    :root{
      --bg:#f1f5f9;
      --text:#0f172a;
      --muted:#64748b;

      --headerGlass: rgba(255,255,255,0.86);
      --headerBlur: 6px;

      --softHover: rgba(15,23,42,0.06);
      --overlay: rgba(0,0,0,0.18);

      --card:#ffffff;
      --border:#eef0f6;

      --wrap: 520px;
      --mainH: 46px;

      --vvh: 100vh;
      --modalEase: 160ms;

      --stackH: 92px;

      --ringSize:16px;
      --ringStroke:3px;
    }

    body[data-theme="dark"]{
      --bg:#0A0A0A;
      --text:#e5e7eb;
      --muted:#a1a1aa;

      --headerGlass: rgba(10,10,10,0.78);
      --headerBlur: 7px;

      --softHover: rgba(255,255,255,0.08);
      --overlay: rgba(0,0,0,0.35);

      --card: rgba(255,255,255,0.06);
      --border: rgba(255,255,255,0.10);
    }

    html, body{height:100%}
    body{
      font-family:'Outfit', system-ui, sans-serif;
      background:var(--bg);
      color:var(--text);
      -webkit-tap-highlight-color: transparent;
      overscroll-behavior-y: none;
    }

    .pageBlur{transition:filter .18s ease;will-change:filter}
    body.menuOpen .pageBlur{filter:blur(6px)}

    .writoHeaderStack{
      position:sticky;
      top:0;
      z-index:1000;

      background: var(--headerGlass);
      backdrop-filter: blur(var(--headerBlur)) saturate(115%);
      -webkit-backdrop-filter: blur(var(--headerBlur)) saturate(115%);

      border-bottom:1px solid rgba(255,255,255,0.10);
      box-shadow:0 2px 10px rgba(15,23,42,0.06);
      overflow:hidden;
      transform: translateZ(0);
    }
    body[data-theme="dark"] .writoHeaderStack{
      border-bottom:1px solid rgba(255,255,255,0.08);
      box-shadow:0 6px 18px rgba(0,0,0,0.35);
    }

    .writoHeader{
      position:absolute;
      top:0; left:0; right:0;
      height:var(--mainH);
      display:flex;
      align-items:center;
      justify-content:space-between;
      padding-left:26px;
      padding-right:18px;
      background:transparent;
      transition: transform .18s ease, opacity .18s ease;
      will-change: transform, opacity;
    }

    .writoHeaderLeft{display:flex;align-items:center;gap:12px}
    .writoBrand{font-size:17px;font-weight:700;letter-spacing:-0.4px}

    .writoIconBtn{
      width:30px;height:30px;
      border:none;background:transparent;
      display:inline-flex;align-items:center;justify-content:center;
      cursor:pointer;padding:0;color:var(--text);
      user-select:none;border-radius:10px;
    }
    .writoIconBtn:hover{background:var(--softHover)}
    .writoIconBtn:active{transform:scale(.98)}
    .writoHeaderRight{display:flex;align-items:center;gap:12px}
    svg.lucide{width:19px;height:19px;stroke-width:1.5}

    .trackerBar{
      border-top:1px solid rgba(255,255,255,0.10);
      padding:4px 0 5px;
      padding-top: calc(var(--mainH) + 4px);
      transition: padding-top .18s ease;
      will-change: padding-top;
    }

    body.compactHeader .writoHeader{
      transform: translateY(-100%);
      opacity:0;
      pointer-events:none;
    }
    body.compactHeader .trackerBar{
      padding-top: 6px;
      border-top:none;
    }

    .trackerInner{
      width:min(var(--wrap), calc(100vw - 28px));
      margin:0 auto;
      display:flex;
      align-items:center;
      gap:10px;
      padding:0 2px;
    }

    .progressWrap{
      width:var(--ringSize);
      height:var(--ringSize);
      display:grid;
      place-items:center;
      flex:0 0 auto;
    }
    .progressSvg{
      width:var(--ringSize);
      height:var(--ringSize);
      transform:rotate(-90deg);
    }
    .ringTrack{
      fill:none;
      stroke:rgba(255,255,255,0.18);
      stroke-width:var(--ringStroke);
    }
    body:not([data-theme="dark"]) .ringTrack{stroke:rgba(15,23,42,0.18)}
    .ringFill{
      fill:none;
      stroke:rgba(255,255,255,0.92);
      stroke-width:var(--ringStroke);
      stroke-linecap:round;
      stroke-dasharray:100;
      stroke-dashoffset:100;
      transition:stroke-dashoffset 110ms linear;
      will-change: stroke-dashoffset;
    }
    body:not([data-theme="dark"]) .ringFill{stroke:rgba(15,23,42,0.92)}

    .trkTitle{
      flex:1;
      min-width:0;
      font-size:12px;
      color:var(--muted);
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
      font-weight:300;
    }
    .trkTitle span{color:var(--text);font-weight:300}

    .tocBtn{
      border:none;background:transparent;
      cursor:pointer;
      display:grid;place-items:center;
      width:30px;height:30px;
      border-radius:10px;color:var(--text);
    }
    .tocBtn:hover{background: var(--softHover)}
    .tocBtn:active{transform:scale(.98)}
    .chev{width:18px;height:18px;transition:transform .18s ease}

    .writoOverlay{
      position:fixed; inset:0;
      background:var(--overlay);
      opacity:0; pointer-events:none;
      transition:opacity .16s ease;
      z-index:1200;
    }
    body.hasOverlay .writoOverlay{opacity:1;pointer-events:auto}

    .writoMenu{
      position:fixed; top:0; left:0;
      width:230px; height:100vh;
      background: rgba(255,255,255,0.72);
      backdrop-filter: blur(14px) saturate(140%);
      -webkit-backdrop-filter: blur(14px) saturate(140%);
      border-right:1px solid rgba(255,255,255,0.4);
      transform:translateX(-100%);
      transition:.20s ease;
      z-index:1300;
      padding:16px;
      pointer-events:none;
    }
    body[data-theme="dark"] .writoMenu{
      background: rgba(10,10,10,0.60);
      border-right:1px solid rgba(255,255,255,0.14);
    }
    body.menuOpen .writoMenu{transform:translateX(0);pointer-events:auto}

    .writoMenuHeader{display:flex;justify-content:flex-end;margin-bottom:16px}
    .writoMenuHeader .writoIconBtn{background: rgba(255,255,255,0.20)}
    body[data-theme="dark"] .writoMenuHeader .writoIconBtn{background: rgba(255,255,255,0.06)}

    .writoMenuItem{
      display:flex; align-items:center; gap:14px;
      font-size:15px;
      padding:12px 0;
      cursor:pointer;
      border-bottom:1px solid rgba(0,0,0,0.12);
      color:var(--text);
      font-weight:300;
      text-decoration:none;
    }
    body[data-theme="dark"] .writoMenuItem{border-bottom:1px solid rgba(255,255,255,0.12)}
    .writoMenuItem:last-child{border-bottom:none}

    .writoModal{
      position:fixed;
      left:50%;
      top:72px;
      transform: translateX(-50%) translateY(10px);
      width: min(var(--wrap), calc(100vw - 28px));
      background: rgba(255,255,255,0.72);
      backdrop-filter: blur(14px) saturate(140%);
      -webkit-backdrop-filter: blur(14px) saturate(140%);
      border:1px solid rgba(255,255,255,0.35);
      border-radius:18px;
      box-shadow: 0 18px 50px rgba(0,0,0,0.15);
      z-index:1400;

      opacity:0;
      pointer-events:none;
      transition: opacity var(--modalEase) ease, transform var(--modalEase) ease;
      will-change: transform, opacity;
      contain: paint;
      max-height: calc(var(--vvh) - 90px);
      overflow:auto;
      -webkit-overflow-scrolling: touch;
    }
    body.compactHeader .writoModal{ top:54px; }
    body[data-theme="dark"] .writoModal{
      background: rgba(10,10,10,0.64);
      border:1px solid rgba(255,255,255,0.14);
      box-shadow: 0 20px 60px rgba(0,0,0,0.55);
    }
    .writoModal.open{
      opacity:1;
      pointer-events:auto;
      transform: translateX(-50%) translateY(0);
    }

    .writoModalInner{padding:14px}
    .writoModalHead{
      display:flex; align-items:center; justify-content:space-between; gap:10px;
      padding-bottom:10px;
      border-bottom:1px solid rgba(0,0,0,0.10);
      margin-bottom:12px;
    }
    body[data-theme="dark"] .writoModalHead{border-bottom:1px solid rgba(255,255,255,0.12)}
    .writoModalTitle{display:flex; align-items:center; gap:10px;font-size:14px; font-weight:700}

    .writoModalClose{
      width:34px;height:34px;border-radius:12px;
      border:1px solid rgba(0,0,0,0.10);
      background: rgba(255,255,255,0.30);
      display:inline-flex;align-items:center;justify-content:center;
      cursor:pointer;color:var(--text);
    }
    body[data-theme="dark"] .writoModalClose{
      border:1px solid rgba(255,255,255,0.12);
      background: rgba(255,255,255,0.06);
    }

    .writoSearchInput{
      width:100%;
      height:40px;
      border-radius:14px;
      border:1px solid rgba(0,0,0,0.10);
      background: rgba(255,255,255,0.55);
      padding:0 12px;
      font-family:inherit;
      font-size:13px;
      color:var(--text);
      outline:none;
    }
    body[data-theme="dark"] .writoSearchInput{
      border:1px solid rgba(255,255,255,0.12);
      background: rgba(255,255,255,0.06);
    }

    .writoHint{margin-top:10px;font-size:12px;font-weight:300;color:var(--muted);line-height:1.5}

    body.kbd .writoModal,
    body.kbd .writoOverlay{transition:none !important;}

    @media (max-width: 600px){
      .writoModal{
        left: 50%;
        top: auto;
        bottom: 12px;
        transform: translateX(-50%) translateY(10px);
        width: calc(100vw - 24px);
        max-height: calc(var(--vvh) - 24px);
        border-radius:18px;
        backdrop-filter: none !important;
        -webkit-backdrop-filter: none !important;
      }
      .writoModal.open{transform: translateX(-50%) translateY(0)}
      body[data-theme="dark"] .writoModal{
        background: rgba(10,10,10,0.92) !important;
        box-shadow: 0 18px 55px rgba(0,0,0,0.60);
      }
    }

    .pageSection{
      width:min(var(--wrap), calc(100vw - 28px));
      margin:0 auto;
      padding-top:16px;
      padding-bottom:24px;
      min-height: calc(var(--vvh) - 180px);
    }
    .emptyNote{
      border:1px solid rgba(255,255,255,0.10);
      background: rgba(255,255,255,0.04);
      border-radius:18px;
      padding:14px;
      color:rgba(255,255,255,0.70);
      font-weight:300;
      font-size:13px;
      line-height:1.7;
    }
    body:not([data-theme="dark"]) .emptyNote{
      border:1px solid rgba(15,23,42,0.10);
      background: rgba(15,23,42,0.03);
      color:rgba(15,23,42,0.70);
    }

    .post{background:var(--card); border:1px solid var(--border); border-radius:18px; padding:16px; margin-bottom:16px; box-shadow:0 6px 18px rgba(16,24,40,.04)}
    .section-header{display:flex; justify-content:space-between; align-items:center; margin:24px 0 14px}
    .section-title{font-size:1.1rem; font-weight:700}
    .view-all-btn{text-decoration:none; color:var(--text); font-size:0.9rem; font-weight:500}
    .tag{display:inline-block; background:rgba(148,163,184,0.16); padding:4px 8px; border-radius:6px; font-size:0.8rem; margin-bottom:8px; color:var(--muted)}
    input, textarea, select{width:100%; padding:12px; margin:8px 0; border-radius:10px; border:1px solid rgba(148,163,184,0.4); background:transparent; color:var(--text)}
    button.sub-btn{width:100%; padding:12px; background:var(--text); color:var(--bg); border:none; cursor:pointer; font-weight:700; border-radius:10px}
    img{max-width:100%; height:auto; border-radius:12px}

    .flash-msg{background:rgba(250,204,21,0.18); padding:10px; margin-bottom:10px; border-radius:10px; text-align:center; color:var(--text)}
    .auth-form{max-width:420px; margin:40px auto; background:var(--card); padding:30px; border-radius:18px; box-shadow:0 6px 18px rgba(16,24,40,.04)}

    .author-row{display:flex; align-items:center; gap:10px; margin-top:8px}
    .author-avatar{width:36px; height:36px; border-radius:50%; background:rgba(148,163,184,0.2); overflow:hidden; display:flex; align-items:center; justify-content:center; font-weight:700; color:var(--muted); font-size:0.9rem; flex-shrink:0}
    .author-avatar img{width:100%; height:100%; object-fit:cover; border-radius:50%}
    .author-name{font-weight:700; color:var(--text); font-size:0.95rem; text-decoration:none}
    .author-meta{font-size:0.8rem; color:var(--muted)}

    .bookmark-list{list-style:none; max-height:300px; overflow-y:auto}
    .bookmark-item{display:flex; justify-content:space-between; align-items:center; padding:10px 0; border-bottom:1px solid rgba(148,163,184,0.2)}
    .bm-link{text-decoration:none; color:var(--text); font-weight:600; font-size:14px; flex:1; margin-right:10px}
    .bm-remove{color:#ef4444; font-size:18px; cursor:pointer; text-decoration:none}

    .subRow{margin-top:10px; padding-top:10px; border-top:1px solid rgba(148,163,184,0.2); display:flex; align-items:center; justify-content:space-between; gap:10px}
    .subTitle{color:var(--text); font-size:14px; font-weight:700; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; flex:1}
    .moreBtn{height:36px; width:78px; border-radius:12px; border:1px solid rgba(148,163,184,0.3); background:transparent; color:var(--text); font-size:13px; font-weight:700; cursor:pointer; display:flex; align-items:center; justify-content:center}
    .moreList{display:none; margin-top:10px; padding-top:10px; border-top:1px solid rgba(148,163,184,0.2); max-height:50vh; overflow-y:auto}
    .moreList.open{display:block; animation: slideDown 0.3s ease}
    .moreItem{width:100%; padding:12px; border-radius:12px; border:1px solid rgba(148,163,184,0.2); background:var(--card); color:var(--text); font-size:13px; font-weight:600; cursor:pointer; margin-bottom:8px}

    .writoFooterWrap{max-width:520px;margin:0 auto;padding:0 14px 18px}
    .writoFooter{margin-top:28px; background:var(--card); border:1px solid var(--border); border-radius:18px; padding:16px; box-shadow:0 6px 18px rgba(16,24,40,.04); display:flex; flex-direction:column; gap:12px}
    .minLogo{font-size:16px; font-weight:700; letter-spacing:.2px; color:var(--text); line-height:1.1}
    .minCopy{margin-top:6px; font-size:12px; font-weight:300; color:var(--muted)}

    .minSocial{display:flex; gap:14px; align-items:center}
    .minSocial a{color:var(--text); text-decoration:none; display:inline-flex; align-items:center; justify-content:center; padding:2px; border:none; background:transparent; opacity:.9}
    .minSocial a:hover{opacity:1}
    .minSocial i{font-size:18px}

    .minLinks{display:flex; align-items:center; gap:10px; flex-wrap:wrap; font-size:12px; font-weight:400; color:var(--muted)}
    .minLinks a{color:var(--muted); text-decoration:none}
    .minLinks a:hover{color:var(--text)}
    .minLinks .dot{opacity:.6}

    @keyframes slideDown { from { opacity: 0; transform: translateY(-10px); } to { opacity: 1; transform: translateY(0); } }
  </style>
</head>

<body data-theme="dark">
  <div class="pageBlur">
    <div class="writoHeaderStack" id="headerStack">
      <header class="writoHeader" id="mainHeader">
        <div class="writoHeaderLeft">
          <button class="writoIconBtn" id="writoOpenMenu" type="button" aria-label="Open menu">
            <span data-lucide="menu"></span>
          </button>
          <div class="writoBrand">Writo</div>
        </div>

        <div class="writoHeaderRight">
          <button class="writoIconBtn" id="writoBtnSearch" type="button" aria-label="Search">
            <span data-lucide="search"></span>
          </button>
          <button class="writoIconBtn" id="writoBtnBookmark" type="button" aria-label="Bookmarks">
            <span data-lucide="bookmark"></span>
          </button>

          <button class="writoIconBtn" id="writoBtnTheme" type="button" aria-label="Toggle theme">
            <span id="writoIconMoon" data-lucide="moon"></span>
            <span id="writoIconSun" data-lucide="sun" style="display:none"></span>
          </button>
        </div>
      </header>

      <div class="trackerBar" id="articleTracker">
        <div class="trackerInner">
          <div class="progressWrap" aria-label="Reading progress">
            <svg class="progressSvg" viewBox="0 0 36 36" aria-hidden="true">
              <path class="ringTrack" d="M18 2 a 16 16 0 0 1 0 32 a 16 16 0 0 1 0 -32"/>
              <path class="ringFill" id="ringFill" d="M18 2 a 16 16 0 0 1 0 32 a 16 16 0 0 1 0 -32"/>
            </svg>
          </div>

          <div class="trkTitle">
            <span id="currentSection">{% block header_title %}Writo{% endblock %}</span>
          </div>

          <button class="tocBtn" id="tocBtn" type="button" aria-label="Demo button">
            <svg class="chev" viewBox="0 0 24 24" aria-hidden="true">
              <path d="M6 9l6 6 6-6" fill="none" stroke="currentColor" stroke-width="2.4" stroke-linecap="round" stroke-linejoin="round"></path>
            </svg>
          </button>
        </div>
      </div>
      {% block header_extension %}{% endblock %}
    </div>

    <div class="pageSection">
      {% with messages = get_flashed_messages() %}
        {% if messages %}
          {% for message in messages %}
            <div class="flash-msg">{{ message }}</div>
          {% endfor %}
        {% endif %}
      {% endwith %}
      {% block content %}{% endblock %}
    </div>

    <section style="width:100%">
      <div class="writoFooterWrap">
        <footer class="writoFooter">
          <div>
            <div class="minLogo">Writo</div>
            <div class="minCopy">© ২০২৬ • All rights reserved</div>
          </div>

          <div class="minSocial" aria-label="Social links">
            <a href="#" aria-label="Facebook"><i class="fa-brands fa-facebook-f"></i></a>
            <a href="#" aria-label="X (Twitter)"><i class="fa-brands fa-x-twitter"></i></a>
            <a href="#" aria-label="Instagram"><i class="fa-brands fa-instagram"></i></a>
            <a href="#" aria-label="YouTube"><i class="fa-brands fa-youtube"></i></a>
          </div>

          <div class="minLinks">
            <a href="#">Privacy Policy</a>
            <span class="dot">•</span>
            <a href="#">Terms</a>
          </div>
        </footer>
      </div>
    </section>
  </div>

  <div class="writoOverlay" id="writoOverlay"></div>

  <aside class="writoMenu" id="writoMenu">
    <div class="writoMenuHeader">
      <button class="writoIconBtn" id="writoCloseMenu" type="button" aria-label="Close menu">
        <span data-lucide="x"></span>
      </button>
    </div>

    <a class="writoMenuItem" href="/">
      <span data-lucide="home"></span><span>হোম</span>
    </a>
    <a class="writoMenuItem" href="/list?type=latest">
      <span data-lucide="clock"></span><span>সকল পোস্ট</span>
    </a>
    <a class="writoMenuItem" href="/writers">
      <span data-lucide="users"></span><span>রাইটার</span>
    </a>
    {% if current_user.is_authenticated %}
      <a class="writoMenuItem" href="/profile">
        <span data-lucide="user"></span><span>প্রোফাইল ম্যানেজমেন্ট</span>
      </a>
      {% if current_user.is_admin %}
        <a class="writoMenuItem" href="/admin_dashboard">
          <span data-lucide="layout-grid"></span><span>ড্যাশবোর্ড</span>
        </a>
      {% else %}
        <a class="writoMenuItem" href="/my_posts">
          <span data-lucide="file-text"></span><span>আমার পোস্ট</span>
        </a>
      {% endif %}
      <a class="writoMenuItem" href="/logout">
        <span data-lucide="log-out"></span><span>লগ আউট</span>
      </a>
    {% else %}
      <a class="writoMenuItem" href="/login">
        <span data-lucide="log-in"></span><span>লগ ইন</span>
      </a>
      <a class="writoMenuItem" href="/signup">
        <span data-lucide="user-plus"></span><span>সাইন আপ</span>
      </a>
    {% endif %}
  </aside>

  <section class="writoModal" id="writoModalSearch" aria-hidden="true">
    <div class="writoModalInner">
      <div class="writoModalHead">
        <div class="writoModalTitle"><span data-lucide="search"></span> Search</div>
        <button class="writoModalClose" type="button" data-writo-close aria-label="Close">
          <span data-lucide="x"></span>
        </button>
      </div>
      <form action="/search" method="get">
        <input class="writoSearchInput" id="writoSearchInput" type="search" name="q" placeholder="কী খুঁজতে চান?" required />
        <div class="writoHint">টাইটেল, ক্যাটাগরি বা কনটেন্ট দিয়ে সার্চ করুন।</div>
      </form>
    </div>
  </section>

  <section class="writoModal" id="writoModalSaved" aria-hidden="true">
    <div class="writoModalInner">
      <div class="writoModalHead">
        <div class="writoModalTitle"><span data-lucide="bookmark"></span> Saved</div>
        <button class="writoModalClose" type="button" data-writo-close aria-label="Close">
          <span data-lucide="x"></span>
        </button>
      </div>
      {% if current_user.is_authenticated %}
        {% if my_bookmarks %}
          <ul class="bookmark-list">
            {% for bm in my_bookmarks %}
              <li class="bookmark-item">
                <a href="{{ url_for('post_detail', post_id=bm['id'], slug=bm['slug']) }}" class="bm-link">{{ bm['title'] }}</a>
                <a href="/toggle_bookmark/{{ bm['id'] }}" class="bm-remove" title="Remove">&times;</a>
              </li>
            {% endfor %}
          </ul>
        {% else %}
          <div class="emptyNote">কোনো বুকমার্ক সেভ করা নেই।</div>
        {% endif %}
      {% else %}
        <div class="emptyNote">বুকমার্ক দেখতে <a href="/login">লগ ইন</a> করুন।</div>
      {% endif %}
    </div>
  </section>

  <script>
    lucide.createIcons();

    function updateVVH(){
      const h = window.visualViewport ? window.visualViewport.height : window.innerHeight;
      document.documentElement.style.setProperty("--vvh", h + "px");
    }
    updateVVH();
    if (window.visualViewport){
      window.visualViewport.addEventListener("resize", updateVVH, { passive:true });
      window.visualViewport.addEventListener("scroll", updateVVH, { passive:true });
    } else {
      window.addEventListener("resize", updateVVH, { passive:true });
    }

    const W = {
      body: document.body,
      overlay: document.getElementById("writoOverlay"),
      menu: document.getElementById("writoMenu"),
      openMenu: document.getElementById("writoOpenMenu"),
      closeMenu: document.getElementById("writoCloseMenu"),

      modalSearch: document.getElementById("writoModalSearch"),
      modalSaved: document.getElementById("writoModalSaved"),

      btnSearch: document.getElementById("writoBtnSearch"),
      btnBookmark: document.getElementById("writoBtnBookmark"),
      searchInput: document.getElementById("writoSearchInput"),

      btnTheme: document.getElementById("writoBtnTheme"),
      iconMoon: document.getElementById("writoIconMoon"),
      iconSun: document.getElementById("writoIconSun"),

      ring: document.getElementById("ringFill"),
    };

    function applyTheme(theme){
      W.body.setAttribute("data-theme", theme);
      const isDark = theme === "dark";
      W.iconMoon.style.display = isDark ? "none" : "inline-block";
      W.iconSun.style.display  = isDark ? "inline-block" : "none";
      localStorage.setItem("writoTheme", theme);
    }
    applyTheme(localStorage.getItem("writoTheme")==="light" ? "light" : "dark");

    W.btnTheme.addEventListener("click", () => {
      const next = W.body.getAttribute("data-theme")==="dark" ? "light" : "dark";
      applyTheme(next);
    });

    function anyOpen(){
      return W.body.classList.contains("menuOpen")
        || W.modalSearch.classList.contains("open")
        || W.modalSaved.classList.contains("open");
    }
    function syncOverlay(){
      if (anyOpen()) W.body.classList.add("hasOverlay");
      else W.body.classList.remove("hasOverlay");
    }
    function closeAll(){
      const ae = document.activeElement;
      if (ae && ae.blur) ae.blur();

      requestAnimationFrame(() => {
        W.body.classList.remove("menuOpen");
        W.modalSearch.classList.remove("open");
        W.modalSaved.classList.remove("open");
        syncOverlay();
      });
    }

    W.openMenu.addEventListener("click", () => {
      W.modalSearch.classList.remove("open");
      W.modalSaved.classList.remove("open");
      W.body.classList.add("menuOpen");
      syncOverlay();
    });
    W.closeMenu.addEventListener("click", () => {
      W.body.classList.remove("menuOpen");
      syncOverlay();
    });

    function openModal(modal){
      W.body.classList.remove("menuOpen");
      W.modalSearch.classList.remove("open");
      W.modalSaved.classList.remove("open");

      modal.classList.add("open");
      syncOverlay();

      const CAN_AUTOFOCUS = window.matchMedia("(hover:hover) and (pointer:fine)").matches;
      if(modal === W.modalSearch && CAN_AUTOFOCUS){
        modal.addEventListener("transitionend", () => {
          try{ W.searchInput.focus({preventScroll:true}); }
          catch{ W.searchInput.focus(); }
        }, { once:true });
      }
    }

    W.btnSearch.addEventListener("click", () => openModal(W.modalSearch));
    W.btnBookmark.addEventListener("click", () => openModal(W.modalSaved));

    document.querySelectorAll("[data-writo-close]").forEach(btn => btn.addEventListener("click", closeAll));
    W.overlay.addEventListener("click", closeAll);
    window.addEventListener("keydown", (e) => { if(e.key==="Escape") closeAll(); });

    let raf = 0;
    function updateProgress(){
      const doc = document.documentElement;
      const total = (doc.scrollHeight - window.innerHeight);
      const p = total <= 0 ? 1 : Math.min(1, Math.max(0, window.scrollY / total));
      if (W.ring) W.ring.style.strokeDashoffset = String(100 - (p * 100));
    }
    function onScroll(){
      if (raf) return;
      raf = requestAnimationFrame(() => {
        updateProgress();
        raf = 0;
      });
    }
    updateProgress();
    addEventListener("scroll", onScroll, { passive:true });
    addEventListener("resize", updateProgress);

    let lastY = Math.max(0, window.scrollY || 0);
    let ticking = false;
    let compact = false;
    let lastToggle = 0;

    const COMPACT_ON = 90;
    const EXPAND_AT  = 35;
    const DELTA      = 2;
    const COOLDOWN   = 180;

    function setCompact(next){
      const now = performance.now();
      if (next === compact) return;
      if (now - lastToggle < COOLDOWN) return;

      compact = next;
      document.body.classList.toggle("compactHeader", compact);
      lastToggle = now;
    }

    function onScrollSmart(){
      const y = Math.max(0, window.scrollY || 0);
      const d = y - lastY;

      if (y <= EXPAND_AT) setCompact(false);
      else {
        if (d > DELTA && y >= COMPACT_ON) setCompact(true);
        if (d < -DELTA) setCompact(false);
      }

      lastY = y;
      ticking = false;
    }

    function tick(){
      if (ticking) return;
      ticking = true;
      requestAnimationFrame(onScrollSmart);
    }
    window.addEventListener("scroll", tick, { passive:true });
  </script>
</body>
</html>
