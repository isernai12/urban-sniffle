<!DOCTYPE html>
<html lang="bn">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>{% block title %}পাইথন ব্লগ কমিউনিটি{% endblock %}</title>

  <!-- Font -->
  <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;500;700&display=swap" rel="stylesheet">

  <!-- Icons -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
  <script src="https://unpkg.com/lucide@latest"></script>

  <style>
    *{margin:0;padding:0;box-sizing:border-box}

    :root{
      --bg:#f1f5f9;
      --text:#0f172a;
      --muted:#64748b;

      --headerGlass: rgba(255,255,255,0.86);
      --headerBlur: 6px;

      --softHover: rgba(15,23,42,0.06);
      --overlay: rgba(0,0,0,0.18);

      --card:#ffffff;
      --border:#eef0f6;

      --wrap: 520px;
      --mainH: 46px;

      --vvh: 100vh;
      --modalEase: 160ms;

      --ringSize:16px;
      --ringStroke:3px;
    }

    body[data-theme="dark"]{
      --bg:#0A0A0A;
      --text:#e5e7eb;
      --muted:#a1a1aa;

      --headerGlass: rgba(10,10,10,0.78);
      --headerBlur: 7px;

      --softHover: rgba(255,255,255,0.08);
      --overlay: rgba(0,0,0,0.35);

      --card: rgba(255,255,255,0.06);
      --border: rgba(255,255,255,0.10);
    }

    html, body{height:100%}
    body{
      font-family:'Outfit', system-ui, sans-serif;
      background:var(--bg);
      color:var(--text);
      -webkit-tap-highlight-color: transparent;
      overscroll-behavior-y: none;
    }

    /* ✅ blur off (fix your blur issue) */
    .pageBlur{min-height:100vh;display:flex;flex-direction:column;}
    body.menuOpen .pageBlur{filter:none !important;}

    /* =========================
       HEADER
       ========================= */
    .writoHeaderStack{
      position:sticky;
      top:0;
      z-index:1000;

      background: var(--headerGlass);
      backdrop-filter: blur(var(--headerBlur)) saturate(115%);
      -webkit-backdrop-filter: blur(var(--headerBlur)) saturate(115%);

      border-bottom:1px solid rgba(255,255,255,0.10);
      box-shadow:0 2px 10px rgba(15,23,42,0.06);
      overflow:hidden;
      transform: translateZ(0);
    }
    body[data-theme="dark"] .writoHeaderStack{
      border-bottom:1px solid rgba(255,255,255,0.08);
      box-shadow:0 6px 18px rgba(0,0,0,0.35);
    }

    .writoHeader{
      position:relative;
      height:var(--mainH);
      display:flex;
      align-items:center;
      justify-content:space-between;
      padding-left:18px;
      padding-right:14px;
      background:transparent;
      transition: transform .18s ease, opacity .18s ease;
      will-change: transform, opacity;
    }

    .writoHeaderLeft{display:flex;align-items:center;gap:10px}
    .writoBrand{font-size:17px;font-weight:700;letter-spacing:-0.4px}

    .writoIconBtn{
      width:34px;height:34px;
      border:none;background:transparent;
      display:inline-flex;align-items:center;justify-content:center;
      cursor:pointer;padding:0;color:var(--text);
      user-select:none;border-radius:12px;
    }
    .writoIconBtn:hover{background:var(--softHover)}
    .writoIconBtn:active{transform:scale(.98)}
    .writoHeaderRight{display:flex;align-items:center;gap:10px}
    svg.lucide{width:19px;height:19px;stroke-width:1.5}

    /* =========================
       TRACKER (DETAIL ONLY)
       ========================= */
    .trackerBar{
      border-top:1px solid rgba(255,255,255,0.10);
      padding:6px 0 8px;
      transition: padding-top .18s ease;
      will-change: padding-top;
    }

    body.compactHeader .writoHeader{
      transform: translateY(-100%);
      opacity:0;
      pointer-events:none;
    }
    body.compactHeader .trackerBar{
      border-top:none;
      padding-top: 8px;
    }

    .trackerInner{
      width:min(var(--wrap), calc(100vw - 28px));
      margin:0 auto;
      display:flex;
      align-items:center;
      gap:10px;
      padding:0 2px;
    }

    .progressWrap{
      width:var(--ringSize);
      height:var(--ringSize);
      display:grid;
      place-items:center;
      flex:0 0 auto;
    }
    .progressSvg{
      width:var(--ringSize);
      height:var(--ringSize);
      transform:rotate(-90deg);
    }
    .ringTrack{
      fill:none;
      stroke:rgba(255,255,255,0.18);
      stroke-width:var(--ringStroke);
    }
    body:not([data-theme="dark"]) .ringTrack{stroke:rgba(15,23,42,0.18)}
    .ringFill{
      fill:none;
      stroke:rgba(255,255,255,0.92);
      stroke-width:var(--ringStroke);
      stroke-linecap:round;
      stroke-dasharray:100;
      stroke-dashoffset:100;
      transition:stroke-dashoffset 110ms linear;
      will-change: stroke-dashoffset;
    }
    body:not([data-theme="dark"]) .ringFill{stroke:rgba(15,23,42,0.92)}

    .trkTitle{
      flex:1;
      min-width:0;
      font-size:12px;
      color:var(--muted);
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
      font-weight:300;
    }
    .trkTitle span{color:var(--text);font-weight:300}

    .tocBtn{
      border:none;background:transparent;
      cursor:pointer;
      display:grid;place-items:center;
      width:34px;height:34px;
      border-radius:12px;color:var(--text);
    }
    .tocBtn:hover{background: var(--softHover)}
    .tocBtn:active{transform:scale(.98)}
    .chev{width:18px;height:18px;transition:transform .18s ease}
    .tocBtn.open .chev{transform:rotate(180deg)}

    /* Overlay */
    .writoOverlay{
      position:fixed; inset:0;
      background:var(--overlay);
      opacity:0; pointer-events:none;
      transition:opacity .16s ease;
      z-index:1200;
    }
    body.hasOverlay .writoOverlay{opacity:1;pointer-events:auto}

    /* Side Menu */
    .writoMenu{
      position:fixed; top:0; left:0;
      width:250px; height:100vh;
      background: rgba(255,255,255,0.72);
      backdrop-filter: blur(14px) saturate(140%);
      -webkit-backdrop-filter: blur(14px) saturate(140%);
      border-right:1px solid rgba(255,255,255,0.4);
      transform:translateX(-100%);
      transition:.20s ease;
      z-index:1300;
      padding:16px;
      pointer-events:none;
      overflow:auto;
    }
    body[data-theme="dark"] .writoMenu{
      background: rgba(10,10,10,0.60);
      border-right:1px solid rgba(255,255,255,0.14);
    }
    body.menuOpen .writoMenu{transform:translateX(0);pointer-events:auto}

    .writoMenuHeader{display:flex;justify-content:flex-end;margin-bottom:12px}
    .writoMenuHeader .writoIconBtn{background: rgba(255,255,255,0.20)}
    body[data-theme="dark"] .writoMenuHeader .writoIconBtn{background: rgba(255,255,255,0.06)}

    .writoMenuSectionTitle{
      margin:10px 0 8px;
      font-size:12px;
      font-weight:700;
      color:var(--muted);
      letter-spacing:.2px;
      text-transform:uppercase;
    }

    .writoMenuItem{
      display:flex; align-items:center; gap:12px;
      font-size:14px;
      padding:10px 0;
      cursor:pointer;
      border-bottom:1px solid rgba(0,0,0,0.12);
      color:var(--text);
      font-weight:300;
      text-decoration:none;
    }
    body[data-theme="dark"] .writoMenuItem{border-bottom:1px solid rgba(255,255,255,0.12)}
    .writoMenuItem:last-child{border-bottom:none}

    .writoPill{
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding:10px 12px;
      border-radius:14px;
      border:1px solid rgba(0,0,0,0.10);
      background: rgba(255,255,255,0.35);
      text-decoration:none;
      color:var(--text);
      font-weight:700;
      font-size:13px;
      margin-bottom:10px;
    }
    body[data-theme="dark"] .writoPill{
      border:1px solid rgba(255,255,255,0.12);
      background: rgba(255,255,255,0.06);
    }

    /* Modals */
    .writoModal{
      position:fixed;
      left:50%;
      top:72px;
      transform: translateX(-50%) translateY(10px);
      width: min(var(--wrap), calc(100vw - 28px));
      background: rgba(255,255,255,0.72);
      backdrop-filter: blur(14px) saturate(140%);
      -webkit-backdrop-filter: blur(14px) saturate(140%);
      border:1px solid rgba(255,255,255,0.35);
      border-radius:18px;
      box-shadow: 0 18px 50px rgba(0,0,0,0.15);
      z-index:1400;

      opacity:0;
      pointer-events:none;
      transition: opacity var(--modalEase) ease, transform var(--modalEase) ease;
      will-change: transform, opacity;
      contain: paint;
      max-height: calc(var(--vvh) - 90px);
      overflow:auto;
      -webkit-overflow-scrolling: touch;
    }
    body.compactHeader .writoModal{ top:54px; }
    body[data-theme="dark"] .writoModal{
      background: rgba(10,10,10,0.64);
      border:1px solid rgba(255,255,255,0.14);
      box-shadow: 0 20px 60px rgba(0,0,0,0.55);
    }
    .writoModal.open{
      opacity:1;
      pointer-events:auto;
      transform: translateX(-50%) translateY(0);
    }

    .writoModalInner{padding:14px}
    .writoModalHead{
      display:flex; align-items:center; justify-content:space-between; gap:10px;
      padding-bottom:10px;
      border-bottom:1px solid rgba(0,0,0,0.10);
      margin-bottom:12px;
    }
    body[data-theme="dark"] .writoModalHead{border-bottom:1px solid rgba(255,255,255,0.12)}
    .writoModalTitle{display:flex; align-items:center; gap:10px;font-size:14px; font-weight:700}

    .writoModalClose{
      width:34px;height:34px;border-radius:12px;
      border:1px solid rgba(0,0,0,0.10);
      background: rgba(255,255,255,0.30);
      display:inline-flex;align-items:center;justify-content:center;
      cursor:pointer;color:var(--text);
    }
    body[data-theme="dark"] .writoModalClose{
      border:1px solid rgba(255,255,255,0.12);
      background: rgba(255,255,255,0.06);
    }

    .writoSearchInput{
      width:100%;
      height:40px;
      border-radius:14px;
      border:1px solid rgba(0,0,0,0.10);
      background: rgba(255,255,255,0.55);
      padding:0 12px;
      font-family:inherit;
      font-size:13px;
      color:var(--text);
      outline:none;
    }
    body[data-theme="dark"] .writoSearchInput{
      border:1px solid rgba(255,255,255,0.12);
      background: rgba(255,255,255,0.06);
    }

    .writoHint{margin-top:10px;font-size:12px;font-weight:300;color:var(--muted);line-height:1.5}

    /* Content Layout */
    .container{
      width:min(var(--wrap), calc(100vw - 28px));
      margin:0 auto;
      padding:16px 0 20px;
      flex:1;
    }
    .post{
      background:var(--card);
      border:1px solid var(--border);
      border-radius:18px;
      padding:16px;
      box-shadow:0 6px 18px rgba(16,24,40,.04);
      margin-bottom:14px;
    }

    .flash-msg{
      background: rgba(250, 204, 21, .20);
      border:1px solid rgba(250, 204, 21, .35);
      padding: 10px;
      margin: 12px 0;
      border-radius: 14px;
      text-align: center;
      color: var(--text);
      font-size: 13px;
      font-weight: 600;
    }

    /* Footer */
    .writoFooterWrap{max-width:520px;margin:0 auto;padding:0 14px 18px}
    .writoFooter{
      margin-top:18px;
      background:var(--card);
      border:1px solid var(--border);
      border-radius:18px;
      padding:16px;
      box-shadow:0 6px 18px rgba(16,24,40,.04);
      display:flex;
      flex-direction:column;
      gap:12px;
    }
    .minLogo{font-size:16px;font-weight:700;color:var(--text)}
    .minCopy{margin-top:6px;font-size:12px;font-weight:300;color:var(--muted)}
    .minSocial{display:flex;gap:14px;align-items:center}
    .minSocial a{color:var(--text);text-decoration:none;display:inline-flex;align-items:center;justify-content:center;opacity:.9}
    .minSocial a:hover{opacity:1}
    .minSocial i{font-size:18px}
    .minLinks{display:flex;align-items:center;gap:10px;flex-wrap:wrap;font-size:12px;color:var(--muted)}
    .minLinks a{color:var(--muted);text-decoration:none}
    .minLinks a:hover{color:var(--text)}
    .minLinks .dot{opacity:.6}
  </style>

  {% block head_extra %}{% endblock %}
</head>

<body data-theme="dark" class="{% block body_class %}{% endblock %}">
  <div class="pageBlur">

    <!-- Header -->
    <div class="writoHeaderStack" id="headerStack">
      <header class="writoHeader" id="mainHeader">
        <div class="writoHeaderLeft">
          <button class="writoIconBtn" id="writoOpenMenu" type="button" aria-label="Open menu">
            <span data-lucide="menu"></span>
          </button>
          <div class="writoBrand">Writo</div>
        </div>

        <div class="writoHeaderRight">
          <button class="writoIconBtn" id="writoBtnSearch" type="button" aria-label="Search">
            <span data-lucide="search"></span>
          </button>
          <button class="writoIconBtn" id="writoBtnBookmark" type="button" aria-label="Bookmarks">
            <span data-lucide="bookmark"></span>
          </button>

          <button class="writoIconBtn" id="writoBtnTheme" type="button" aria-label="Toggle theme">
            <span id="writoIconMoon" data-lucide="moon"></span>
            <span id="writoIconSun" data-lucide="sun" style="display:none"></span>
          </button>
        </div>
      </header>

      <!-- ✅ TRACKER: ONLY DETAIL PAGE -->
      {% if show_detail_tracker %}
        <div class="trackerBar" id="articleTracker">
          <div class="trackerInner">
            <div class="progressWrap" aria-label="Reading progress">
              <svg class="progressSvg" viewBox="0 0 36 36" aria-hidden="true">
                <path class="ringTrack" d="M18 2 a 16 16 0 0 1 0 32 a 16 16 0 0 1 0 -32"/>
                <path class="ringFill" id="ringFill" d="M18 2 a 16 16 0 0 1 0 32 a 16 16 0 0 1 0 -32"/>
              </svg>
            </div>

            <div class="trkTitle">
              <span id="currentSection">{% block tracker_title %}{% endblock %}</span>
            </div>

            <button class="tocBtn" id="tocBtn" type="button" aria-label="Table of contents">
              <svg class="chev" viewBox="0 0 24 24" aria-hidden="true">
                <path d="M6 9l6 6 6-6" fill="none" stroke="currentColor" stroke-width="2.4" stroke-linecap="round" stroke-linejoin="round"></path>
              </svg>
            </button>
          </div>
        </div>
      {% endif %}

      {% block header_extension %}{% endblock %}
    </div>

    <!-- Overlay -->
    <div class="writoOverlay" id="writoOverlay"></div>

    <!-- Side Menu -->
    <aside class="writoMenu" id="writoMenu">
      <div class="writoMenuHeader">
        <button class="writoIconBtn" id="writoCloseMenu" type="button" aria-label="Close menu">
          <span data-lucide="x"></span>
        </button>
      </div>

      {% if current_user.is_authenticated %}
        <div style="margin-bottom:12px;">
          <div class="writoPill" style="width:100%; justify-content:space-between;">
            <span>স্বাগতম, <strong>{{ current_user.display_name }}</strong></span>
            {% if current_user.is_admin %}<span style="font-size:12px;opacity:.8">(Admin)</span>{% endif %}
          </div>

          <a class="writoPill" href="/profile"><span data-lucide="user"></span> প্রোফাইল</a>

          {% if current_user.is_admin %}
            <a class="writoPill" href="/admin/pending"><span data-lucide="shield"></span> পেন্ডিং রিভিউ</a>
            <a class="writoPill" href="/admin/reports"><span data-lucide="flag"></span> রিপোর্টস</a>
          {% else %}
            <a class="writoPill" href="/my_posts"><span data-lucide="file-text"></span> আমার পোস্ট</a>
          {% endif %}

          <a class="writoPill" href="/logout" style="border-color:rgba(239,68,68,.35)"><span data-lucide="log-out"></span> লগ আউট</a>
        </div>
      {% else %}
        <a class="writoPill" href="/login"><span data-lucide="log-in"></span> লগ ইন</a>
        <a class="writoPill" href="/signup"><span data-lucide="user-plus"></span> সাইন আপ</a>
      {% endif %}

      <div class="writoMenuSectionTitle">ক্যাটাগরি</div>

      <a class="writoMenuItem" href="/"><span data-lucide="home"></span><span>হোম</span></a>
      <a class="writoMenuItem" href="/list?type=latest"><span data-lucide="clock"></span><span>সকল পোস্ট</span></a>

      {% for cat in all_categories %}
        <a class="writoMenuItem" href="/list?type=category&category={{ cat['category'] }}">
          <span data-lucide="layout-grid"></span>
          <span>{{ cat['category'] }}</span>
        </a>
      {% endfor %}
    </aside>

    <!-- Search modal -->
    <section class="writoModal" id="writoModalSearch" aria-hidden="true">
      <div class="writoModalInner">
        <div class="writoModalHead">
          <div class="writoModalTitle"><span data-lucide="search"></span> অনুসন্ধান</div>
          <button class="writoModalClose" type="button" data-writo-close aria-label="Close">
            <span data-lucide="x"></span>
          </button>
        </div>

        <form action="/search" method="get">
          <input class="writoSearchInput" name="q" type="search" placeholder="কী খুঁজতে চান? (টাইটেল, টপিক...)" required />
          <div class="writoHint">Enter চাপলে সার্চ হবে।</div>
        </form>
      </div>
    </section>

    <!-- Bookmark modal -->
    <section class="writoModal" id="writoModalSaved" aria-hidden="true">
      <div class="writoModalInner">
        <div class="writoModalHead">
          <div class="writoModalTitle"><span data-lucide="bookmark"></span> আমার বুকমার্ক</div>
          <button class="writoModalClose" type="button" data-writo-close aria-label="Close">
            <span data-lucide="x"></span>
          </button>
        </div>

        {% if current_user.is_authenticated %}
          {% if my_bookmarks %}
            <div style="display:grid; gap:10px;">
              {% for bm in my_bookmarks %}
                <div class="post" style="margin:0; padding:12px; display:flex; align-items:center; justify-content:space-between; gap:10px;">
                  <a href="{{ url_for('post_detail', post_id=bm['id'], slug=bm['slug']) }}"
                     style="text-decoration:none;color:var(--text);font-weight:700;font-size:13px;flex:1;min-width:0;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;">
                    {{ bm['title'] }}
                  </a>
                  <a href="/toggle_bookmark/{{ bm['id'] }}" title="Remove" style="text-decoration:none;font-size:18px;color:#ef4444;">&times;</a>
                </div>
              {% endfor %}
            </div>
          {% else %}
            <div class="writoHint" style="margin:0">কোনো বুকমার্ক সেভ করা নেই।</div>
          {% endif %}
        {% else %}
          <div class="writoHint" style="margin:0">বুকমার্ক দেখতে লগ ইন করুন।</div>
        {% endif %}
      </div>
    </section>

    <!-- ✅ TOC Modal: ONLY DETAIL PAGE -->
    {% if show_detail_tracker %}
      <section class="writoModal" id="writoModalToc" aria-hidden="true">
        <div class="writoModalInner">
          <div class="writoModalHead">
            <div class="writoModalTitle"><span data-lucide="list"></span> সেকশনসমূহ</div>
            <button class="writoModalClose" type="button" data-writo-close aria-label="Close">
              <span data-lucide="x"></span>
            </button>
          </div>

          {% block toc_modal_content %}
            <div class="writoHint" style="margin:0">এই পোস্টে কোনো TOC নেই।</div>
          {% endblock %}
        </div>
      </section>
    {% endif %}

    <!-- Main content -->
    <main class="container">
      {% with messages = get_flashed_messages() %}
        {% if messages %}
          {% for message in messages %}
            <div class="flash-msg">{{ message }}</div>
          {% endfor %}
        {% endif %}
      {% endwith %}

      {% block content %}{% endblock %}
    </main>

    <!-- Footer -->
    <section style="width:100%">
      <div class="writoFooterWrap">
        <footer class="writoFooter">
          <div>
            <div class="minLogo">Writo</div>
            <div class="minCopy">© ২০২৬ • All rights reserved</div>
          </div>

          <div class="minSocial" aria-label="Social links">
            <a href="#" aria-label="Facebook"><i class="fa-brands fa-facebook-f"></i></a>
            <a href="#" aria-label="X (Twitter)"><i class="fa-brands fa-x-twitter"></i></a>
            <a href="#" aria-label="Instagram"><i class="fa-brands fa-instagram"></i></a>
            <a href="#" aria-label="YouTube"><i class="fa-brands fa-youtube"></i></a>
          </div>

          <div class="minLinks">
            <a href="#">Privacy Policy</a>
            <span class="dot">•</span>
            <a href="#">Terms</a>
          </div>
        </footer>
      </div>
    </section>

  </div>

  <script>
    lucide.createIcons();

    // visual viewport height updater (mobile keyboard safe)
    function updateVVH(){
      const h = window.visualViewport ? window.visualViewport.height : window.innerHeight;
      document.documentElement.style.setProperty("--vvh", h + "px");
    }
    updateVVH();
    if (window.visualViewport){
      window.visualViewport.addEventListener("resize", updateVVH, { passive:true });
      window.visualViewport.addEventListener("scroll", updateVVH, { passive:true });
    } else {
      window.addEventListener("resize", updateVVH, { passive:true });
    }

    const W = {
      body: document.body,
      overlay: document.getElementById("writoOverlay"),
      menu: document.getElementById("writoMenu"),
      openMenu: document.getElementById("writoOpenMenu"),
      closeMenu: document.getElementById("writoCloseMenu"),

      modalSearch: document.getElementById("writoModalSearch"),
      modalSaved: document.getElementById("writoModalSaved"),
      modalToc: document.getElementById("writoModalToc"), // may be null on non-detail pages

      btnSearch: document.getElementById("writoBtnSearch"),
      btnBookmark: document.getElementById("writoBtnBookmark"),
      btnToc: document.getElementById("tocBtn"), // may be null on non-detail pages

      searchInput: document.querySelector("#writoModalSearch .writoSearchInput"),

      btnTheme: document.getElementById("writoBtnTheme"),
      iconMoon: document.getElementById("writoIconMoon"),
      iconSun: document.getElementById("writoIconSun"),

      ring: document.getElementById("ringFill") // may be null on non-detail pages
    };

    function applyTheme(theme){
      W.body.setAttribute("data-theme", theme);
      const isDark = theme === "dark";
      if (W.iconMoon) W.iconMoon.style.display = isDark ? "none" : "inline-block";
      if (W.iconSun)  W.iconSun.style.display  = isDark ? "inline-block" : "none";
      localStorage.setItem("writoTheme", theme);
    }
    applyTheme(localStorage.getItem("writoTheme")==="light" ? "light" : "dark");

    if (W.btnTheme){
      W.btnTheme.addEventListener("click", () => {
        const next = W.body.getAttribute("data-theme")==="dark" ? "light" : "dark";
        applyTheme(next);
      });
    }

    function anyOpen(){
      return W.body.classList.contains("menuOpen")
        || W.modalSearch.classList.contains("open")
        || W.modalSaved.classList.contains("open")
        || (W.modalToc && W.modalToc.classList.contains("open"));
    }
    function syncOverlay(){
      if (anyOpen()) W.body.classList.add("hasOverlay");
      else W.body.classList.remove("hasOverlay");
    }
    function closeAll(){
      const ae = document.activeElement;
      if (ae && ae.blur) ae.blur();

      requestAnimationFrame(() => {
        W.body.classList.remove("menuOpen");
        W.modalSearch.classList.remove("open");
        W.modalSaved.classList.remove("open");
        if (W.modalToc) W.modalToc.classList.remove("open");
        if (W.btnToc) W.btnToc.classList.remove("open");
        syncOverlay();
      });
    }

    // Menu open/close
    if (W.openMenu){
      W.openMenu.addEventListener("click", () => {
        W.modalSearch.classList.remove("open");
        W.modalSaved.classList.remove("open");
        if (W.modalToc) W.modalToc.classList.remove("open");
        if (W.btnToc) W.btnToc.classList.remove("open");
        W.body.classList.add("menuOpen");
        syncOverlay();
      });
    }
    if (W.closeMenu){
      W.closeMenu.addEventListener("click", () => {
        W.body.classList.remove("menuOpen");
        syncOverlay();
      });
    }

    // Modals
    function openModal(modal){
      W.body.classList.remove("menuOpen");
      W.modalSearch.classList.remove("open");
      W.modalSaved.classList.remove("open");
      if (W.modalToc) W.modalToc.classList.remove("open");
      if (W.btnToc) W.btnToc.classList.remove("open");

      modal.classList.add("open");
      syncOverlay();

      const CAN_AUTOFOCUS = window.matchMedia("(hover:hover) and (pointer:fine)").matches;
      if(modal === W.modalSearch && CAN_AUTOFOCUS && W.searchInput){
        modal.addEventListener("transitionend", () => {
          try{ W.searchInput.focus({preventScroll:true}); }
          catch{ W.searchInput.focus(); }
        }, { once:true });
      }
    }

    if (W.btnSearch)   W.btnSearch.addEventListener("click", () => openModal(W.modalSearch));
    if (W.btnBookmark) W.btnBookmark.addEventListener("click", () => openModal(W.modalSaved));

    // TOC only if exists
    if (W.btnToc && W.modalToc){
      W.btnToc.addEventListener("click", () => {
        const hasItems = W.modalToc.querySelector("[data-toc-item]") !== null;
        if (!hasItems) return;

        const isOpen = W.modalToc.classList.contains("open");
        if (isOpen) closeAll();
        else {
          openModal(W.modalToc);
          W.btnToc.classList.add("open");
        }
      });
    }

    document.querySelectorAll("[data-writo-close]").forEach(btn => btn.addEventListener("click", closeAll));
    if (W.overlay) W.overlay.addEventListener("click", closeAll);
    window.addEventListener("keydown", (e) => { if(e.key==="Escape") closeAll(); });

    // Progress ring fill based on scroll (only if ring exists)
    let raf = 0;
    function updateProgress(){
      if (!W.ring) return;
      const doc = document.documentElement;
      const total = (doc.scrollHeight - window.innerHeight);
      const p = total <= 0 ? 1 : Math.min(1, Math.max(0, window.scrollY / total));
      W.ring.style.strokeDashoffset = String(100 - (p * 100));
    }
    function onScroll(){
      if (!W.ring) return;
      if (raf) return;
      raf = requestAnimationFrame(() => {
        updateProgress();
        raf = 0;
      });
    }
    updateProgress();
    addEventListener("scroll", onScroll, { passive:true });
    addEventListener("resize", updateProgress);

    // Compact header behavior (works on all pages, tracker may or may not exist)
    let lastY = Math.max(0, window.scrollY || 0);
    let ticking = false;
    let compact = false;
    let lastToggle = 0;

    const COMPACT_ON = 90;
    const EXPAND_AT  = 35;
    const DELTA      = 2;
    const COOLDOWN   = 180;

    function setCompact(next){
      const now = performance.now();
      if (next === compact) return;
      if (now - lastToggle < COOLDOWN) return;

      compact = next;
      document.body.classList.toggle("compactHeader", compact);
      lastToggle = now;
    }

    function onScrollSmart(){
      const y = Math.max(0, window.scrollY || 0);
      const d = y - lastY;

      if (y <= EXPAND_AT) setCompact(false);
      else {
        if (d > DELTA && y >= COMPACT_ON) setCompact(true);
        if (d < -DELTA) setCompact(false);
      }

      lastY = y;
      ticking = false;
    }

    function tick(){
      if (ticking) return;
      ticking = true;
      requestAnimationFrame(onScrollSmart);
    }
    window.addEventListener("scroll", tick, { passive:true });
  </script>

  {% block body_scripts %}{% endblock %}
</body>
</html>
