{% extends 'base.html' %}

{% block content %}
  <style>
    .wrap{max-width:980px;margin:0 auto;padding:14px}
    @media(max-width:1020px){ .wrap{max-width:520px} }

    .grid2{
      display:grid;
      grid-template-columns: 1fr 1.15fr;
      gap:12px;
      align-items:start;
    }
    @media(max-width:1020px){ .grid2{grid-template-columns:1fr} }

    .card{
      background:var(--card);
      border:1px solid var(--border);
      border-radius:18px;
      box-shadow:0 6px 18px rgba(16,24,40,.04);
      overflow:hidden;
    }
    .cardInner{padding:14px}

    .cardTitle{
      display:flex;align-items:center;gap:10px;
      font-size:13px;font-weight:900;
      letter-spacing:-0.2px;
    }
    .cardSub{
      margin-top:6px;
      font-size:12px;
      font-weight:300;
      color:var(--muted);
      line-height:1.55;
    }

    .divider{height:1px;background:var(--border);margin:12px 0}

    .row{display:flex;gap:10px;flex-wrap:wrap}
    .field{display:flex;flex-direction:column;gap:8px;min-width:0;flex:1}
    .label{font-size:11px;font-weight:700;color:var(--text);letter-spacing:.15px; display: flex; justify-content: space-between; align-items: center;}
    .input, .textarea, .select{
      width:100%;
      border-radius:14px;
      border:1px solid var(--softBorder);
      background: rgba(255,255,255,0.55);
      padding:10px 12px;
      font-family:inherit;
      font-size:12px;
      color:var(--text);
      outline:none;
    }
    body[data-theme="dark"] .input,
    body[data-theme="dark"] .textarea,
    body[data-theme="dark"] .select{
      background: rgba(255,255,255,0.06);
      border:1px solid rgba(255,255,255,0.12);
    }
    .textarea{min-height:90px;resize:none;line-height:1.6}

    .hint{
      font-size:11px;
      font-weight:300;
      color:var(--muted);
      line-height:1.5;
    }

    .btnRow{display:flex;gap:10px;flex-wrap:wrap;margin-top:10px}
    .btn{
      height:36px;
      padding:0 12px;
      border-radius:999px;
      border:1px solid var(--softBorder);
      background: rgba(255,255,255,0.35);
      color:var(--text);
      font-size:12px;
      font-weight:900;
      cursor:pointer;
      display:inline-flex;
      align-items:center;
      gap:8px;
      user-select:none;
    }
    body[data-theme="dark"] .btn{background: rgba(255,255,255,0.06)}
    .btn:active{transform:scale(.98)}
    .btn.primary{
      background:#0f172a;color:#fff;border:1px solid rgba(15,23,42,0.30);
    }
    body[data-theme="dark"] .btn.primary{
      background: rgba(255,255,255,0.14);
      border:1px solid rgba(255,255,255,0.16);
      color: var(--text);
    }
    .btn[disabled]{opacity:.55;cursor:not-allowed}

    .uploadGrid{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:10px;
      margin-top:10px;
    }
    @media(max-width:520px){ .uploadGrid{grid-template-columns:1fr} }

    .uploadBox{
      border:1px solid var(--softBorder);
      background: rgba(255,255,255,0.35);
      border-radius:18px;
      padding:12px;
      display:flex;
      flex-direction:column;
      gap:10px;
    }
    body[data-theme="dark"] .uploadBox{background: rgba(255,255,255,0.06)}
    .uploadTop{
      display:flex;align-items:center;justify-content:space-between;gap:10px
    }
    .badge{
      display:inline-flex;align-items:center;gap:8px;
      font-size:11px;font-weight:900;color:var(--text);
      white-space:nowrap;
    }
    .badge svg{width:16px;height:16px}

    .preview{
      width:100%;
      height:120px;
      border-radius:14px;
      overflow:hidden;
      background: rgba(15,23,42,0.06);
      border:1px solid rgba(0,0,0,0.06);
    }
    body[data-theme="dark"] .preview{
      background: rgba(255,255,255,0.06);
      border:1px solid rgba(255,255,255,0.08);
    }
    .preview img{width:100%;height:100%;object-fit:cover;display:block}
    .fileInput{display:none}
    .fileBtn{width:max-content}

    .lockNote{
      margin-top:10px;
      padding:12px;
      border-radius:16px;
      border:1px solid var(--softBorder);
      background: rgba(255,255,255,0.35);
      color:var(--muted);
      font-size:12px;
      font-weight:300;
      line-height:1.55;
    }
    body[data-theme="dark"] .lockNote{background: rgba(255,255,255,0.06)}
    .lockNote strong{color:var(--text);font-weight:900}

    .previewCardTop{
      display:flex;align-items:center;justify-content:space-between;gap:10px;flex-wrap:wrap
    }
    .miniPill{
      height:30px;
      padding:0 10px;
      border-radius:999px;
      border:1px solid var(--softBorder);
      background: rgba(255,255,255,0.35);
      font-size:11px;
      font-weight:900;
      color:var(--text);
      display:inline-flex;align-items:center;gap:8px;
    }
    body[data-theme="dark"] .miniPill{background: rgba(255,255,255,0.06)}
    .miniPill svg{width:14px;height:14px}

    .postPreview{
      margin-top:10px;
      border-radius:18px;
      overflow:hidden;
      border:1px solid var(--border);
      background:var(--card);
      box-shadow:0 6px 18px rgba(16,24,40,.04);
    }
    .postThumb{height:160px;background: rgba(15,23,42,0.06)}
    body[data-theme="dark"] .postThumb{background: rgba(255,255,255,0.06)}
    .postThumb img{width:100%;height:100%;object-fit:cover;display:block}
    .postBody{padding:12px;display:flex;flex-direction:column;gap:8px}
    .pTitle{
      font-size:14px;font-weight:900;letter-spacing:-0.2px;line-height:1.35;
      display:-webkit-box;-webkit-line-clamp:2;-webkit-box-orient:vertical;overflow:hidden;
    }
    .pExcerpt{
      font-size:12px;font-weight:300;color:var(--muted);line-height:1.55;
      display:-webkit-box;-webkit-line-clamp:3;-webkit-box-orient:vertical;overflow:hidden;
    }
    .metaRow{
      display:flex;gap:10px;flex-wrap:wrap;align-items:center;
      color:var(--muted);font-size:11px;font-weight:300;
    }
    .metaRow span{display:inline-flex;align-items:center;gap:6px;white-space:nowrap}
    .metaRow svg{width:14px;height:14px;stroke-width:1.7}
  </style>

  <main class="wrap">
    <form method="post" enctype="multipart/form-data">
      <section class="grid2">
        <section class="card" id="setupCard">
          <div class="cardInner">
            <div class="cardTitle"><span data-lucide="image"></span> Setup (Required)</div>
            <div class="cardSub">Normal thumbnail দরকার, Trending thumbnail ঐচ্ছিক।</div>

            <div class="divider"></div>

            <div class="cardTitle"><span data-lucide="images"></span> Thumbnails</div>
            <div class="cardSub">Normal + Trending (Trending page এর জন্য)</div>

            <div class="uploadGrid">
              <div class="uploadBox">
                <div class="uploadTop">
                  <div class="badge"><span data-lucide="image"></span> Normal Thumbnail</div>
                  <label class="btn fileBtn" for="fileNormal"><span data-lucide="upload"></span> Upload</label>
                  <input class="fileInput" id="fileNormal" name="thumbnail" type="file" accept="image/*" required>
                </div>
                <div class="preview">
                  <img id="imgNormal" alt="Normal preview" style="display:none">
                </div>
                <div class="hint">Recommended: 1200×630 (16:9)</div>
              </div>

              <div class="uploadBox">
                <div class="uploadTop">
                  <div class="badge"><span data-lucide="flame"></span> Trending Thumbnail</div>
                  <label class="btn fileBtn" for="fileTrending"><span data-lucide="upload"></span> Upload</label>
                  <input class="fileInput" id="fileTrending" name="trending_thumbnail" type="file" accept="image/*">
                </div>
                <div class="preview">
                  <img id="imgTrending" alt="Trending preview" style="display:none">
                </div>
                <div class="hint">Recommended: trending ratio</div>
              </div>
            </div>

            <div class="btnRow">
              <button class="btn primary" id="btnSaveSetup" type="button">
                <span data-lucide="check-circle-2"></span> Save Setup
              </button>
              <button class="btn" id="btnResetSetup" type="button">
                <span data-lucide="rotate-ccw"></span> Reset
              </button>
            </div>

            <div class="lockNote" id="setupNote">
              <strong>Status:</strong> Setup not completed yet. <br>
              Normal thumbnail আপলোড করলে পোস্ট submit হবে।
            </div>
          </div>
        </section>

        <section class="card" id="postCard">
          <div class="cardInner">
            <div class="previewCardTop">
              <div>
                <div class="cardTitle"><span data-lucide="square-pen"></span> Add Post</div>
                <div class="cardSub">সব ফিল্ড পূরণ করে সাবমিট করুন।</div>
              </div>
              <div class="miniPill" id="lockPill"><span data-lucide="lock"></span> Locked</div>
            </div>

            <div class="divider"></div>

            <div class="field">
              <div class="label">
                <span>Post Title</span>
              </div>
              <input class="input" id="pTitle" name="title" type="text" placeholder="Write your post title" required>
            </div>

            <div style="height:10px"></div>

            <div class="row">
              <div class="field">
                <div class="label">Category</div>
                <input class="input" id="pCat" name="category" type="text" list="cat-list" placeholder="Select" required>
                <datalist id="cat-list">
                  <option value="Technology">
                  <option value="Design">
                  <option value="AI">
                  <option value="Business">
                  <option value="Lifestyle">
                </datalist>
              </div>
              <div class="field">
                <div class="label">
                  <span>Tag (Max 1)</span>
                </div>
                <input class="input" id="pTags" type="text" placeholder="e.g. nextjs">
              </div>
            </div>

            <div style="height:10px"></div>

            <div class="field">
              <div class="label">
                <span>Short Excerpt</span>
              </div>
              <textarea class="textarea" id="pExcerpt" name="intro" placeholder="Short summary (will show on cards)" required></textarea>
            </div>

            <div style="height:10px"></div>

            <div class="field">
              <div class="label">
                <span>Post Content</span>
              </div>
              <textarea class="textarea" id="pContent" name="content" style="min-height:140px" placeholder="# Heading ..." required></textarea>
              <div class="hint">ডেমো: এখানে কনটেন্ট লিখবেন।</div>
            </div>

            <div class="btnRow">
              <button class="btn" id="btnPreview" type="button">
                <span data-lucide="eye"></span> Preview Card
              </button>
              <button class="btn" id="btnDraft" type="submit" name="action" value="draft" disabled>
                <span data-lucide="save"></span> Add as Draft
              </button>
              <button class="btn primary" id="btnSubmit" type="submit" name="action" value="submit" disabled>
                <span data-lucide="send"></span> Submit Post
              </button>
            </div>

            <div class="lockNote" id="postNote">
              <strong>Note:</strong> Normal thumbnail আপলোড করলে Submit/Draft enabled হবে।
            </div>

            <div class="divider"></div>

            <div class="cardTitle"><span data-lucide="layout-template"></span> Card Preview</div>
            <div class="postPreview">
              <div class="postThumb">
                <img id="prevPostImg" alt="post thumb" style="display:none">
              </div>
              <div class="postBody">
                <div class="pTitle" id="prevTitle">Your post title will appear here…</div>
                <div class="pExcerpt" id="prevExcerpt">Short excerpt preview…</div>
                <div class="metaRow">
                  <span><span data-lucide="calendar"></span><span id="prevDate">Jan 11, 2026</span></span>
                  <span><span data-lucide="tag"></span><span id="prevTags">tags</span></span>
                </div>
              </div>
            </div>

            <div class="hint" style="margin-top:10px">
              Card preview-তে Normal thumbnail দেখাবে। Trending thumbnail Trending page-এ ব্যবহার হবে।
            </div>
          </div>
        </section>
      </section>
    </form>
  </main>

  <script>
    lucide.createIcons();

    const setupNote = document.getElementById("setupNote");
    const lockPill = document.getElementById("lockPill");
    const btnSaveSetup = document.getElementById("btnSaveSetup");
    const btnResetSetup = document.getElementById("btnResetSetup");

    const fileNormal = document.getElementById("fileNormal");
    const fileTrending = document.getElementById("fileTrending");
    const imgNormal = document.getElementById("imgNormal");
    const imgTrending = document.getElementById("imgTrending");

    const pTitle = document.getElementById("pTitle");
    const pTags = document.getElementById("pTags");
    const pExcerpt = document.getElementById("pExcerpt");

    const btnSubmit = document.getElementById("btnSubmit");
    const btnDraft = document.getElementById("btnDraft");
    const btnPreview = document.getElementById("btnPreview");

    const prevPostImg = document.getElementById("prevPostImg");
    const prevTitle = document.getElementById("prevTitle");
    const prevExcerpt = document.getElementById("prevExcerpt");
    const prevTags = document.getElementById("prevTags");
    const prevDate = document.getElementById("prevDate");

    let normalThumbURL = "";
    let trendingThumbURL = "";

    function setSetupState(ready){
      btnSubmit.disabled = !ready;
      btnDraft.disabled = !ready;

      lockPill.innerHTML = ready
        ? `<span data-lucide="unlock"></span> Unlocked`
        : `<span data-lucide="lock"></span> Locked`;

      setupNote.innerHTML = ready
        ? `<strong>Status:</strong> Setup completed ✅ <br> এখন আপনি পোস্ট সাবমিট করতে পারবেন।`
        : `<strong>Status:</strong> Setup not completed yet. <br> Normal thumbnail আপলোড করলে পোস্ট unlock হবে।`;

      const note = document.getElementById("postNote");
      note.innerHTML = ready
        ? `<strong>Ready:</strong> এখন পোস্ট লিখে Submit বা Draft হিসেবে সেভ করুন।`
        : `<strong>Note:</strong> Normal thumbnail আপলোড না হলে Submit/Draft disabled থাকবে।`;

      lucide.createIcons();
    }

    function readFileToImg(file, imgEl, cb){
      if(!file) return;
      const url = URL.createObjectURL(file);
      imgEl.src = url;
      imgEl.style.display = "block";
      cb && cb(url);
    }

    fileNormal.addEventListener("change", (e)=>{
      const file = e.target.files && e.target.files[0];
      readFileToImg(file, imgNormal, (url)=>{
        normalThumbURL = url;
        prevPostImg.src = url;
        prevPostImg.style.display = "block";
        setSetupState(true);
      });
    });

    fileTrending.addEventListener("change", (e)=>{
      const file = e.target.files && e.target.files[0];
      readFileToImg(file, imgTrending, (url)=>{ trendingThumbURL = url; });
    });

    btnSaveSetup.addEventListener("click", ()=>{
      if(!normalThumbURL){
        alert("Setup incomplete!\n\nRequired:\n- Normal thumbnail");
        return;
      }
      setSetupState(true);
      prevDate.textContent = new Date().toLocaleDateString("en-US", { year:"numeric", month:"short", day:"2-digit" });
      alert("Setup saved. Now you can submit posts.");
    });

    btnResetSetup.addEventListener("click", ()=>{
      if(confirm("Reset setup data?")){
        setSetupState(false);

        imgNormal.style.display = "none";
        imgTrending.style.display = "none";
        prevPostImg.style.display = "none";
        normalThumbURL = "";
        trendingThumbURL = "";

        fileNormal.value = "";
        fileTrending.value = "";
        alert("Reset done.");
      }
    });

    function updateCardPreview(){
      prevTitle.textContent = (pTitle.value || "").trim() || "Your post title will appear here…";
      prevExcerpt.textContent = (pExcerpt.value || "").trim() || "Short excerpt preview…";
      const tags = (pTags.value || "").trim();
      prevTags.textContent = tags ? tags : "tags";
    }
    [pTitle, pExcerpt, pTags].forEach(el=> el.addEventListener("input", updateCardPreview));

    btnPreview.addEventListener("click", ()=>{
      updateCardPreview();
      alert("Preview updated.");
    });

    setSetupState(false);
    updateCardPreview();
  </script>
{% endblock %}
